import{r as d,j as e,u as Te,q as it,a as lt,o as ct,Y as dt,Z as L,_ as ot,M as we,$ as mt,H as xt,J as Ce,a0 as ut,a1 as ht}from"./index-c208d5f4.js";import{c as S}from"./combatService-f27cbddc.js";function bt({deadPlayer:l,combatSession:i,onSpectate:m}){var v,_;const[x,y]=d.useState(0);d.useEffect(()=>{const u=setInterval(()=>{y(R=>R+1)},1e3);return()=>clearInterval(u)},[]);const t=u=>{const R=Math.floor(u/60),U=u%60;return`${R}:${U.toString().padStart(2,"0")}`},p=((v=i==null?void 0:i.partyMembers)==null?void 0:v.filter(u=>u.hp>0))||[],o=((_=i==null?void 0:i.enemies)==null?void 0:_.filter(u=>u.hp>0))||[];return e.jsx("div",{className:"fantasy-container py-8",children:e.jsx("div",{className:"fantasy-card bg-red-50 border-red-200",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"💀"}),e.jsx("h1",{className:"text-3xl font-bold text-red-800 mb-4",children:"Character Death"}),e.jsxs("div",{className:"text-xl text-red-700 mb-6",children:[l.name," has fallen in battle..."]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg border border-red-300 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-stone-800 mb-2",children:"Fallen Hero"}),e.jsxs("p",{className:"text-stone-600 mb-2",children:[e.jsx("strong",{children:"Name:"})," ",l.name]}),e.jsxs("p",{className:"text-stone-600 mb-2",children:[e.jsx("strong",{children:"Class:"})," ",l.class]}),e.jsxs("p",{className:"text-stone-600 mb-2",children:[e.jsx("strong",{children:"Level:"})," ",l.level]}),e.jsxs("p",{className:"text-stone-600 mb-2",children:[e.jsx("strong",{children:"Final HP:"})," ",l.hp,"/",l.maxHp]}),e.jsxs("p",{className:"text-stone-600",children:[e.jsx("strong",{children:"Time of Death:"})," ",t(x)]})]}),e.jsxs("div",{className:"bg-gray-100 p-6 rounded-lg border border-gray-300 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Combat Status"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-semibold text-green-700",children:"Alive Allies"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:p.length}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:p.map(u=>u.name).join(", ")})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-semibold text-red-700",children:"Remaining Enemies"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:o.length}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:o.map(u=>u.name).join(", ")})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-blue-800 mb-2",children:"What happens next?"}),e.jsxs("ul",{className:"text-blue-700 text-sm space-y-1",children:[e.jsx("li",{children:"• You must wait for combat to end"}),e.jsx("li",{children:"• If your allies win, you'll create a new character"}),e.jsx("li",{children:"• If all allies die, the campaign ends"}),e.jsx("li",{children:"• Your new character will join the story where it left off"})]})]}),e.jsx("button",{onClick:m,className:"fantasy-button bg-gray-600 hover:bg-gray-700 text-white",children:"Spectate Combat"})]})]})})})}function pt({story:l,deadCharacters:i,combatSummary:m}){var t;const x=Te(),y=()=>{x("/dashboard")};return e.jsx("div",{className:"fantasy-container py-8",children:e.jsx("div",{className:"fantasy-card bg-red-900/20 border-red-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-8xl mb-6",children:"💀"}),e.jsx("h1",{className:"text-4xl font-bold text-red-300 mb-4",children:"Campaign Defeat"}),e.jsx("div",{className:"text-xl text-red-200 mb-8",children:"The party has fallen... The story ends here."}),e.jsxs("div",{className:"bg-gray-800 p-6 rounded-lg border border-red-600 mb-6 text-left",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-100 mb-4",children:"The Complete Story"}),e.jsx("div",{className:"space-y-4 text-gray-300",children:(t=l==null?void 0:l.storyMessages)==null?void 0:t.map((p,o)=>e.jsxs("div",{className:"border-l-2 border-gray-600 pl-4",children:[e.jsxs("p",{className:"font-semibold text-gray-200",children:[p.sender,":"]}),e.jsx("p",{children:p.content})]},o))})]}),e.jsxs("div",{className:"bg-gray-800 p-6 rounded-lg border border-red-600 mb-6",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-100 mb-4",children:"Fallen Heroes"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:i==null?void 0:i.map((p,o)=>e.jsxs("div",{className:"bg-red-900/30 p-4 rounded border border-red-600",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-200 mb-2",children:p.name}),e.jsxs("p",{className:"text-gray-300 mb-1",children:[e.jsx("strong",{children:"Class:"})," ",p.class]}),e.jsxs("p",{className:"text-gray-300 mb-1",children:[e.jsx("strong",{children:"Level:"})," ",p.level]}),e.jsxs("p",{className:"text-gray-300 mb-1",children:[e.jsx("strong",{children:"Final HP:"})," ",p.hp,"/",p.maxHp]}),e.jsxs("p",{className:"text-gray-300",children:[e.jsx("strong",{children:"Cause of Death:"})," ",p.deathCause||"Combat wounds"]})]},o))})]}),m&&e.jsxs("div",{className:"bg-gray-800 p-6 rounded-lg border border-red-600 mb-6",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-100 mb-4",children:"Final Battle"}),e.jsxs("div",{className:"text-gray-300 space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Duration:"})," ",m.duration," rounds"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Result:"})," ",m.result]}),m.narrative&&e.jsx("p",{className:"italic",children:m.narrative})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"The adventure has ended, but new stories await..."}),e.jsx("button",{onClick:y,className:"fantasy-button bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 text-lg",children:"Begin a New Adventure"})]})]})})})}const Se=d.memo(({currentCombatant:l,combatSession:i})=>e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"fantasy-title mb-0",children:"⚔️ Combat Arena"}),l&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-2xl font-bold text-amber-400",children:["🎲 ",l.name,"'s Turn"]}),e.jsxs("div",{className:"text-sm text-gray-400",children:["Round ",(i==null?void 0:i.round)||1," • Turn ",((i==null?void 0:i.currentTurn)||0)+1]})]})]}),i.storyContext&&e.jsxs("div",{className:"fantasy-card mb-4 bg-gray-800/50 border-gray-600",children:[e.jsx("h3",{className:"font-bold text-gray-100 mb-2",children:"📖 Story Context"}),e.jsx("p",{className:"text-gray-300 italic",children:i.storyContext})]})]}));Se.displayName="CombatHeader";const gt=Se,Ee=d.memo(({initiativeOrder:l,currentTurn:i,round:m,onTurnClick:x})=>!l||l.length===0?null:e.jsxs("div",{className:"fantasy-card mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-100",children:"🎯 Turn Order"}),e.jsxs("div",{className:"text-sm text-slate-400",children:["Round ",m," • Turn ",i+1," of ",l.length]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:l.map((y,t)=>e.jsxs("div",{onClick:()=>x&&x(t),className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${t===i?"border-amber-500 bg-amber-500/20 text-amber-300":t<i?"border-slate-600 bg-slate-700/30 text-slate-400":"border-slate-500 bg-slate-700/20 text-slate-300 hover:border-slate-400 hover:bg-slate-700/40"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${y.type==="player"?"bg-blue-500 text-white":"bg-red-500 text-white"}`,children:y.type==="player"?"👤":"👹"}),e.jsx("span",{className:"font-medium truncate",children:y.name})]}),e.jsx("div",{className:"text-xs text-slate-400",children:y.initiative||"N/A"})]}),t===i&&e.jsx("div",{className:"mt-2 text-xs text-amber-300 font-medium",children:"⭐ Current Turn"})]},y.id))})]}));Ee.displayName="TurnOrder";const ft=Ee;function yt({battleLog:l}){const i=m=>{const x=document.getElementById("battle-log-container");x&&(x.scrollTop+=m==="up"?-50:50)};return e.jsxs("div",{className:"fantasy-card",children:[e.jsx("h3",{className:"text-sm font-semibold mb-2 text-yellow-400",children:"📜 Battle Log"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>i("up"),className:"absolute top-0 right-0 z-10 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-t transition-colors",children:"↑"}),e.jsx("div",{id:"battle-log-container",className:"h-32 overflow-y-auto space-y-1 text-xs pr-8 scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:l.length===0?e.jsx("p",{className:"text-gray-400",children:"No actions recorded yet..."}):l.slice(-8).map(m=>e.jsxs("div",{className:"border-l-2 border-gray-600 pl-2 py-1",children:[e.jsx("div",{className:"flex justify-between items-start mb-1",children:e.jsxs("span",{className:"text-blue-400",children:["R",m.round]})}),e.jsx("div",{className:`${m.type==="damage"?"text-red-400":m.type==="healing"?"text-green-400":m.type==="death"?"text-red-500 font-semibold":m.type==="status_effect"?"text-purple-400":m.type==="action_failed"?"text-orange-400":m.type==="error"?"text-red-500":"text-gray-200"}`,children:m.description})]},m.id))}),e.jsx("button",{onClick:()=>i("down"),className:"absolute bottom-0 right-0 z-10 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-b transition-colors",children:"↓"})]})]})}function jt({combatants:l,currentCombatant:i}){const m=l.filter(o=>!o.id.startsWith("enemy_")),x=l.filter(o=>o.id.startsWith("enemy_")),y=o=>o.hp<=0?"dead":o.hp<o.maxHp*.5?"low":"healthy",t=o=>{const v=y(o),u=`p-2 rounded border text-xs ${(i==null?void 0:i.id)===o.id?"ring-1 ring-amber-400":""}`;switch(v){case"dead":return`${u} bg-red-900/20 border-red-600`;case"low":return`${u} bg-yellow-900/20 border-yellow-600`;default:return`${u} bg-blue-900/20 border-blue-600`}},p=o=>{switch(y(o)){case"dead":return"text-red-400";case"low":return"text-yellow-400";default:return"text-green-400"}};return e.jsxs("div",{className:"fantasy-card",children:[e.jsx("h3",{className:"font-bold text-gray-100 mb-3 text-sm",children:"⚔️ Combat Status"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-300 mb-2 text-xs",children:"🛡️ Party"}),e.jsx("div",{className:"space-y-1",children:m.map(o=>e.jsx("div",{className:t(o),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium text-gray-100 truncate",children:[o.name,(i==null?void 0:i.id)===o.id&&e.jsx("span",{className:"ml-1 text-amber-400",children:"🎲"})]}),e.jsxs("span",{className:`text-xs ${p(o)}`,children:[o.hp,"/",o.maxHp]})]})},o.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-red-300 mb-2 text-xs",children:"👹 Enemies"}),e.jsx("div",{className:"space-y-1",children:x.map(o=>e.jsx("div",{className:t(o),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium text-gray-100 truncate",children:[o.name,(i==null?void 0:i.id)===o.id&&e.jsx("span",{className:"ml-1 text-amber-400",children:"🎲"})]}),e.jsxs("span",{className:`text-xs ${p(o)}`,children:[o.hp,"/",o.maxHp]})]})},o.id))})]})]})]})}function vt({currentCombatant:l,availableActions:i,selectedAction:m,setSelectedAction:x,selectedTarget:y,setSelectedTarget:t,getValidTargetsForAction:p,executeAction:o,processingTurn:v,isCurrentUserTurn:_}){return l?e.jsxs("div",{className:"fantasy-card bg-gray-800/50 border-gray-600",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-amber-400 mb-1",children:["🎲 ",l.name,"'s Turn"]}),e.jsx("p",{className:"text-gray-300 text-sm",children:_?"Select your action below":"Waiting for this player to act"})]}),_?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-100 mb-3 text-center",children:"⚔️ Available Actions"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:i.map((u,R)=>e.jsxs("button",{onClick:()=>x(u),className:`p-3 rounded-lg border-2 transition-all duration-200 text-left hover:scale-105 ${(m==null?void 0:m.type)===u.type?"border-amber-500 bg-amber-900/30 shadow-lg shadow-amber-500/20":"border-gray-600 bg-gray-700 hover:border-gray-500 hover:bg-gray-600"}`,children:[e.jsx("div",{className:"font-bold text-sm text-gray-100 mb-1",children:u.name}),e.jsx("div",{className:"text-xs text-gray-300 mb-1",children:u.description}),e.jsx("div",{className:"text-xs text-gray-400 bg-gray-800 px-1 py-0.5 rounded inline-block",children:u.priority})]},R))})]}),m&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-100 mb-3 text-center",children:"🎯 Select Target"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:p(m.type).map(u=>e.jsxs("button",{onClick:()=>t(u),className:`p-3 rounded-lg border-2 transition-all duration-200 hover:scale-105 ${(y==null?void 0:y.id)===u.id?"border-red-500 bg-red-900/30 shadow-lg shadow-red-500/20":"border-gray-600 bg-gray-700 hover:border-gray-500 hover:bg-gray-600"}`,children:[e.jsx("div",{className:"font-bold text-sm text-gray-100 mb-1",children:u.name}),e.jsxs("div",{className:"text-xs text-gray-300 mb-1",children:["HP: ",u.hp,"/",u.maxHp," | AC: ",u.ac]}),e.jsx("div",{className:`text-xs px-1 py-0.5 rounded inline-block ${u.id.startsWith("enemy_")?"bg-red-900 text-red-200":"bg-blue-900 text-blue-200"}`,children:u.id.startsWith("enemy_")?"👹 Enemy":"🛡️ Ally"})]},u.id))}),p(m.type).length===0&&e.jsx("div",{className:"text-center p-4 bg-gray-700 border border-gray-600 rounded-lg",children:e.jsx("p",{className:"text-gray-300",children:"No valid targets for this action."})})]}),m&&y&&e.jsx("div",{className:"text-center pt-6",children:e.jsx("button",{onClick:()=>o(m.type,y.id),disabled:v,className:"fantasy-button bg-amber-600 hover:bg-amber-700 text-xl font-bold px-8 py-4 shadow-lg hover:scale-105 transition-all duration-200",children:v?"⚡ Executing...":`⚔️ Execute ${m.name}`})})]}):e.jsxs("div",{className:"bg-blue-900/20 border border-blue-700 rounded-lg p-8 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"⏳"}),e.jsxs("h3",{className:"text-2xl font-bold text-blue-300 mb-4",children:["Waiting for ",l.name," to act"]}),e.jsx("p",{className:"text-blue-200 text-lg",children:"Please wait for the current player to make their move."})]})]}):null}function $t(){var pe,ge,fe,ye,je,ve;const{sessionId:l}=it(),i=Te(),m=lt(),[x,y]=d.useState(null),[t,p]=d.useState(null),[o,v]=d.useState(!0),[_,u]=d.useState([]),[R,U]=d.useState(null),[$e,ne]=d.useState(null),[ie,Ae]=d.useState(""),[le,De]=d.useState(""),[Me,Pe]=d.useState([]),[V,O]=d.useState([]),[X,Y]=d.useState([]),[F,ce]=d.useState(!1),[de,oe]=d.useState(""),[me,xe]=d.useState(""),[E,D]=d.useState(!1),[ue,ee]=d.useState(!1),[$,he]=d.useState(null),[_e,Nt]=d.useState(!1),[Re,wt]=d.useState([]),[He,Ct]=d.useState(null),[Ie,We]=d.useState(null),[ke,Le]=d.useState(!1),[z,q]=d.useState(-1),[J,Z]=d.useState(null),[Fe,M]=d.useState(!1),[te,G]=d.useState(!1),[P,K]=d.useState(new Set),[ze,se]=d.useState([]),[Be,Ue]=d.useState(!1),H=d.useRef(null),g=(pe=m.state)==null?void 0:pe.isTestCombat,C=m.state;d.useEffect(()=>{const s=ct(a=>{if(!a){i("/login");return}y(a)});return()=>s()},[i]),d.useEffect(()=>{g&&C?Oe():l&&(async()=>await ae())()},[g,C,l]),d.useEffect(()=>{const s=async()=>{await ae()},a=async()=>{t!=null&&t.partyId&&(await S.forceCleanupCombatSessions(t.partyId),setTimeout(async()=>{await ae()},1e3))};return window.addEventListener("refreshCombatSession",s),window.addEventListener("cleanupCombatSessions",a),()=>{window.removeEventListener("refreshCombatSession",s),window.removeEventListener("cleanupCombatSessions",a)}},[t==null?void 0:t.partyId]),d.useEffect(()=>{if(l&&!g){H.current&&(H.current(),H.current=null);const s=dt(l,a=>{p(a),v(!1),(a==null?void 0:a.currentTurn)!==void 0&&(z!==a.currentTurn&&!E||E&&z===a.currentTurn)&&q(a.currentTurn),a&&(a.battleLog&&a.battleLog.length>0&&se(a.battleLog),I(a),O(a.environmentalFeatures||[]),Y(a.teamUpOpportunities||[]),Ge())});return H.current=s,()=>{H.current&&(H.current(),H.current=null)}}},[l,g]),d.useEffect(()=>{if(t&&t.combatState==="active"){const s=W();if(s&&s.id.startsWith("enemy_")&&t.currentTurn!==z&&!E&&!F){const c=setTimeout(()=>{Ze()},g?2e3:1e3);return()=>clearTimeout(c)}s&&s.id.startsWith("enemy_")&&t.currentTurn===z&&!E&&!F&&setTimeout(()=>{A()},3e3)}},[t==null?void 0:t.currentTurn,z,E,F,g,t==null?void 0:t.combatants]),d.useEffect(()=>{t&&te&&Xe()&&setTimeout(()=>{G(!1),K(new Set),A()},1e3)},[te,P.size,(ge=t==null?void 0:t.partyMembers)==null?void 0:ge.length]);const Oe=async()=>{try{v(!0);const a={id:"test_combat_session",partyMembers:C.partyMembers.map(n=>{if(!n.hp||!n.maxHp||!n.ac){const{class:r,level:b,constitution:j,dexterity:f}=n,w={Barbarian:12,Fighter:10,Paladin:10,Ranger:10,Cleric:8,Druid:8,Monk:8,Rogue:8,Bard:8,Sorcerer:6,Warlock:8,Wizard:6}[r]||8,tt=Math.floor((j-10)/2),Ne=Math.max(1,(w+tt)*b),st=10,at=Math.floor((f-10)/2),rt={Barbarian:3,Monk:2,Fighter:4,Paladin:4,Cleric:4,Ranger:3,Rogue:2,Bard:2,Druid:2,Sorcerer:0,Warlock:0,Wizard:0}[r]||0,nt=Math.max(10,st+at+rt);return{...n,hp:Ne,maxHp:Ne,ac:nt}}return n})||[],enemies:C.enemies||[],storyContext:C.storyContext||"Test combat environment",combatState:"initialized",currentTurn:0,combatants:[],round:1};if(!a.enemies||a.enemies.length===0){p({...a,status:"no_enemies",combatState:"ended"}),v(!1);return}const c=S.initializeCombat(a.partyMembers,a.enemies,a.storyContext),h={...a,...c,currentTurn:0,combatState:"active"};p(h),v(!1),I(h),O(h.environmentalFeatures||[]),Y(h.teamUpOpportunities||[])}catch(s){console.error("Error initializing test combat:",s),v(!1)}},ae=async()=>{if(l)try{v(!0);const s=Date.now(),[a,c]=await Promise.all([mt(l),xt(l)]);if(We(c),!a){console.error("No combat session found with ID:",l),i("/dashboard");return}const h=a.partyId,n=await Ce(h);try{await ut(h);const b=await Ce(h);u(b)}catch(b){console.warn("Failed to update character stats:",b),u(n)}if(a.enemies&&a.enemies.length===0&&!g){p({...a,status:"no_enemies"});return}let r=a.combatants||[];if(r.length===0){const b=(a.partyMembers||[]).map(f=>({...f,isEnemy:!1,userId:f.userId,cooldowns:f.cooldowns||{},statusEffects:f.statusEffects||[],hp:f.hp??f.maxHp??10,maxHp:f.maxHp??f.hp??10})),j=(a.enemies||[]).map(f=>({...f,isEnemy:!0,userId:null,cooldowns:f.cooldowns||{},statusEffects:f.statusEffects||[],hp:f.hp??f.maxHp??10,maxHp:f.maxHp??f.hp??10}));r=[...b,...j]}if(a.combatState==="initialized"){const b={...a,combatants:r,combatState:"active",currentTurn:0,round:1};await L(l,b),p(b),I(b),O(b.environmentalFeatures||[]),Y(b.teamUpOpportunities||[])}else{const b={...a,combatants:r};p(b),I(b),O(b.environmentalFeatures||[]),Y(b.teamUpOpportunities||[])}}catch(s){console.error("Error loading combat data:",s)}finally{v(!1)}},I=s=>{var r;const a=W(s);if(!a)return;const c=[],h=a.cooldowns||{};Object.entries(S.actionTypes).forEach(([b,j])=>{(h[b]===0||h[b]===void 0)&&c.push({type:b,name:j.name,description:j.description,priority:j.priority,narrativeTemplate:j.narrativeTemplate})});const n=S.classAbilities[(r=a.class)==null?void 0:r.toLowerCase()];n&&(h.special===0||h.special===void 0)&&c.push({type:"special",name:n.name,description:n.description,priority:"high",narrativeTemplate:"{character} uses their {ability}!"}),V.length>0&&c.push({type:"environmental",name:"Use Environment",description:"Use the environment to your advantage",priority:"normal",narrativeTemplate:"{character} uses the {environment} to their advantage!"}),X.length>0&&c.push({type:"teamUp",name:"Team Up",description:"Coordinate with another party member",priority:"high",narrativeTemplate:"{character} coordinates with {ally} for a powerful combination!"}),Pe(c)},N=async s=>{const a=new Date().toLocaleTimeString(),c={id:`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:a,round:(t==null?void 0:t.round)||1,turn:(t==null?void 0:t.currentTurn)||0,...s};if(se(h=>[...h,c]),!g&&l)try{await ht(l,c)}catch(h){console.error("Failed to save battle log to database:",h)}},Ye=async()=>{if(t)try{D(!0),se([]);const s={...t,combatState:"ready",currentTurn:0,round:1};g?(p(s),I(s)):await L(l,s),await N({type:"combat_start",description:"Combat is ready to begin!"})}catch(s){console.error("Error starting combat:",s)}finally{D(!1)}},qe=async()=>{if(t)try{D(!0);const s={...t,combatState:"active"};g?(p(s),I(s)):await L(l,s),await N({type:"combat_begin",description:"Fight!"}),Ue(!0)}catch(s){console.error("Error beginning combat:",s)}finally{D(!1)}},Je=async(s,a,c={})=>{if(!(!t||!be()))try{D(!0);const h=W(),n=t.combatants.find(f=>f.id===a),r=await S.executeAction(t,h.id,s,a,c),b={...t,currentTurn:r.updatedSession.currentTurn,round:r.updatedSession.round,combatants:r.updatedSession.combatants};if(g)p(b);else{const f={currentTurn:r.updatedSession.currentTurn,round:r.updatedSession.round,combatants:r.updatedSession.combatants};await L(l,f)}await N({type:r.success?"action":"action_failed",description:r.narrative}),r.damage>0&&n&&await N({type:"damage",description:`${n.name} takes ${r.damage} damage!`}),r.healing>0&&n&&await N({type:"healing",description:`${n.name} is healed for ${r.healing} HP!`}),Ae(r.narrative),r.description&&De(r.description);const j=S.checkCombatEnd(b);if(j.ended){g?i("/test-environment",{state:{...C,combatResult:j.result}}):await k(j.result);return}h.id.startsWith("enemy_")&&(G(!0),oe(r.narrative),xe(r.description)),r.damage>0&&n&&(Z({targetId:n.id,damage:r.damage,type:"damage"}),M(!0),setTimeout(()=>M(!1),2e3)),r.healing>0&&n&&(Z({targetId:n.id,healing:r.healing,type:"healing"}),M(!0),setTimeout(()=>M(!1),2e3)),U(null),ne(null)}catch(h){console.error("Error executing action:",h),N({type:"error",description:"An error occurred while executing the action."})}finally{D(!1)}},Ze=async()=>{if(!t||t.combatState!=="active")return;const s=W();if(!(!s||!s.id.startsWith("enemy_")))try{D(!0),ce(!0),N({type:"turn_start",actor:s.name,description:`${s.name}'s turn begins`});const a=S.chooseEnemyAction(s,t);if(!a){setTimeout(()=>{A()},1e3);return}const c=a.action,h=a.target;if(!c){setTimeout(()=>{A()},1e3);return}const n=t.combatants.find(b=>b.id===h);if(!n&&c!=="defend"){setTimeout(()=>{A()},1e3);return}N({type:"action",actor:s.name,action:c,target:(n==null?void 0:n.name)||"self",description:`${s.name} uses ${c}${n?` on ${n.name}`:""}`});const r=await S.executeAction(t,s.id,c,h,a);if(r.success){const b={...t,currentTurn:r.updatedSession.currentTurn,round:r.updatedSession.round,combatants:r.updatedSession.combatants};if(g)p(b);else{const T={currentTurn:r.updatedSession.currentTurn,round:r.updatedSession.round,combatants:r.updatedSession.combatants};await L(l,T)}r.damage&&N({type:"damage",actor:s.name,target:(n==null?void 0:n.name)||"self",damage:r.damage,description:`${s.name} deals ${r.damage} damage to ${(n==null?void 0:n.name)||"self"}`}),r.healing&&N({type:"healing",actor:s.name,target:(n==null?void 0:n.name)||"self",healing:r.healing,description:`${s.name} heals ${(n==null?void 0:n.name)||"self"} for ${r.healing} HP`}),r.statusEffects&&r.statusEffects.length>0&&r.statusEffects.forEach(T=>{N({type:"status_effect",actor:s.name,target:(n==null?void 0:n.name)||"self",effect:T.type,description:`${(n==null?void 0:n.name)||"self"} is affected by ${T.type}`})}),r.targetDied&&N({type:"death",actor:s.name,target:(n==null?void 0:n.name)||"self",description:`${(n==null?void 0:n.name)||"self"} has been defeated!`}),r.damage&&n&&(Z({targetId:n.id,damage:r.damage,type:"damage"}),M(!0),setTimeout(()=>M(!1),2e3)),r.healing&&n&&(Z({targetId:n.id,damage:r.healing,type:"healing"}),M(!0),setTimeout(()=>M(!1),2e3));const j=S.generateActionNarrative(s,c,n,a);if(oe(`${s.name} uses ${c}!`),xe(j),r.combatEnded){g?i("/test-environment",{state:{...C,combatResult:r.combatResult}}):await k(r.combatResult);return}if(b.combatants.filter(T=>!T.id.startsWith("enemy_")&&T.hp>0).length===0){g?i("/test-environment",{state:{...C,combatResult:"defeat"}}):await k("defeat");return}q(t.currentTurn)}else console.error("Enemy action execution failed:",r.error),N({type:"action_failed",actor:s.name,action:c,description:`${s.name}'s ${c} failed`}),setTimeout(()=>{A()},1e3)}catch(a){console.error("Error processing enemy turn:",a),N({type:"error",actor:s.name,description:`Error during ${s.name}'s turn`}),setTimeout(()=>{A()},1e3)}finally{D(!1),ce(!1)}},A=async()=>{if(!t||t.combatState!=="active")return;const s=t.combatants.filter(w=>!w.id.startsWith("enemy_")),a=t.combatants.filter(w=>w.id.startsWith("enemy_")),c=s.some(w=>w.hp>0),h=a.some(w=>w.hp>0);if(!c){g?i("/test-environment",{state:{...C,combatResult:"defeat"}}):await k("defeat");return}if(!h){g?i("/test-environment",{state:{...C,combatResult:"victory"}}):await k("victory");return}let n=(t.currentTurn+1)%t.combatants.length,r=0;const b=t.combatants.length;for(;r<b;){const w=t.combatants[n];if(w&&w.hp>0)break;n=(n+1)%t.combatants.length,r++}if(r>=b){g?i("/test-environment",{state:{...C,combatResult:"draw"}}):await k("draw");return}const j={currentTurn:n};n===0&&(j.round=t.round+1),g?p(w=>({...w,...j})):await L(l,j),q(n);const f=t.combatants[n];f&&await N({type:"turn_advance",description:`🎲 ${f.name}'s turn begins`});const T={...t,...j};I(T)},k=async(s="victory")=>{if(!t)return;const a=S.generateCombatSummary(t,s);if(g)p(c=>({...c,status:"ended",combatState:"ended",summary:a})),i("/test-environment");else{await ot(l,{status:"ended",combatState:"ended",summary:a});const c=t.partyMembers.filter(h=>h.hp<=0);if(c.length>0){await we(l,{status:"storytelling",currentCombat:null,deadPlayers:c.map(n=>({userId:n.userId,name:n.name,class:n.class,level:n.level,deathCause:"Combat wounds"}))});const h=c.find(n=>n.userId===(x==null?void 0:x.uid));i(h?`/character-creation/${t.partyId}`:`/campaign/${l}`)}else await we(l,{status:"storytelling",currentCombat:null}),i(`/campaign/${l}`)}},W=(s=t)=>!(s!=null&&s.combatants)||!Array.isArray(s.combatants)||s.currentTurn===void 0?null:s.combatants[s.currentTurn]||null,be=()=>{const s=W();return s&&s.userId===(x==null?void 0:x.uid)},Ge=()=>{if(t){if(g){const s=t.combatants.find(a=>!a.isEnemy);s&&s.hp<=0&&(ee(!0),he(s))}else if(x){const s=t.partyMembers.find(a=>a.userId===x.uid)||t.combatants.find(a=>a.userId===x.uid&&!a.isEnemy);s&&s.hp<=0&&(ee(!0),he(s))}}},Ke=()=>{g&&i("/dashboard")},Qe=()=>{Le(!0),ee(!1)},Ve=()=>{if(g)G(!1),K(new Set),A();else{const s=x==null?void 0:x.uid;s&&K(a=>new Set([...a,s]))}},Xe=()=>{if(!(t!=null&&t.partyMembers))return!1;const s=t.partyMembers.filter(a=>a.hp>0);return P.size>=s.length},et=s=>{var n;if(!s||!((n=t==null?void 0:t.combatants)!=null&&n.length))return[];const a=t.combatants.filter(r=>r.hp>0),c=W();if(!c)return[];const h=!c.id.startsWith("enemy_");switch(s){case"attack":case"spell":case"special":return h?a.filter(r=>r.id.startsWith("enemy_")):a.filter(r=>!r.id.startsWith("enemy_"));case"heal":case"item":return h?a.filter(r=>!r.id.startsWith("enemy_")&&r.id!==c.id):a.filter(r=>r.id.startsWith("enemy_")&&r.id!==c.id);case"defend":case"environmental":return[c];case"teamUp":return h?a.filter(r=>!r.id.startsWith("enemy_")&&r.id!==c.id):a.filter(r=>r.id.startsWith("enemy_")&&r.id!==c.id);default:return a}},re=Array.isArray(t==null?void 0:t.enemies)?t.enemies:[],B=Array.isArray(t==null?void 0:t.combatants)?t.combatants:[];if(!x)return null;if(o)return e.jsx("div",{className:"fantasy-container py-8",children:e.jsx("div",{className:"fantasy-card",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-4xl mb-4",children:"⚔️"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-100 mb-4",children:"Loading Combat..."}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Preparing the battlefield and gathering combatants..."}),e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500 mx-auto"})]})})});if(!t)return e.jsx("div",{className:"fantasy-container py-8",children:e.jsx("div",{className:"fantasy-card",children:e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"text-gray-400",children:"No active combat session found."})})})});if((t.status==="no_enemies"||re.length===0)&&!g)return e.jsx("div",{className:"fantasy-container py-8",children:e.jsx("div",{className:"fantasy-card",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-4xl mb-4",children:"🕊️"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-100 mb-4",children:"No Enemies to Fight"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"There are no enemies present in this area. Combat cannot begin."}),e.jsx("p",{className:"text-gray-400 text-sm",children:"The combat session will end automatically."})]})})});const Q=W();return _e?e.jsx(pt,{story:Ie,deadCharacters:Re,combatSummary:He}):ue&&$&&!ke?e.jsx(bt,{deadPlayer:$,combatSession:t,onSpectate:Qe}):e.jsx("div",{className:"min-h-screen bg-gray-900 text-gray-100 p-4",children:e.jsxs("div",{className:"fantasy-container py-4",children:[e.jsx(gt,{currentCombatant:Q,combatSession:t}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsx(ft,{combatants:B,currentTurn:t==null?void 0:t.currentTurn}),e.jsx(yt,{battleLog:ze})]}),e.jsxs("div",{className:"lg:col-span-3 space-y-6",children:[(()=>Q&&B.length>0)()&&e.jsx(vt,{currentCombatant:Q,availableActions:Me,selectedAction:R,setSelectedAction:U,selectedTarget:$e,setSelectedTarget:ne,getValidTargetsForAction:et,executeAction:Je,processingTurn:E,isCurrentUserTurn:be()}),(!B.length||!re.length)&&e.jsxs("div",{className:"fantasy-card bg-gray-800 border-gray-600",children:[e.jsx("h3",{className:"font-bold text-gray-100 mb-3",children:"Combat Status"}),e.jsxs("div",{className:"text-gray-300 space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Combat State:"})," ",t.combatState]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Combatants:"})," ",B.length]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Enemies:"})," ",re.length]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Current Turn:"})," ",t.currentTurn]}),t.combatState==="preparation"&&e.jsx("button",{onClick:Ye,className:"fantasy-button bg-yellow-600 hover:bg-yellow-700 mt-4",children:"Start Combat"})]})]}),ie&&e.jsxs("div",{className:"fantasy-card bg-green-900/20 border-green-700",children:[e.jsx("h4",{className:"font-bold text-green-300 mb-2",children:"Action Result"}),e.jsx("p",{className:"text-green-200",children:ie}),le&&e.jsx("div",{className:"mt-2 p-3 bg-gray-700 border border-green-600 rounded",children:e.jsx("p",{className:"text-gray-200 italic",children:le})})]}),F&&e.jsx("div",{className:"fantasy-card bg-red-900/20 border-red-700 animate-pulse",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"font-bold text-red-300 mb-3 text-xl",children:"🦹 Enemy Turn"}),de&&e.jsx("div",{className:"text-red-200 font-bold text-lg mb-3 bg-gray-700 p-3 rounded border border-red-600",children:de}),me&&e.jsx("div",{className:"mt-3 p-4 bg-gray-700 border border-red-600 rounded",children:e.jsx("p",{className:"text-gray-200 italic",children:me})}),e.jsxs("div",{className:"mt-4 flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"}),e.jsx("span",{className:"ml-3 text-red-300 font-medium",children:"Enemy is acting..."})]})]})}),te&&e.jsx("div",{className:"fantasy-card bg-blue-900/20 border-blue-700",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"font-bold text-blue-300 mb-3 text-xl",children:"✅ Enemy Turn Complete"}),e.jsx("p",{className:"text-blue-200 mb-4",children:g?"The enemy has finished their turn. Click 'Confirm' to proceed to the next turn.":"The enemy has finished their turn. All party members must click 'Confirm' to proceed."}),!g&&e.jsxs("div",{className:"mb-4 p-3 bg-gray-700 border border-blue-600 rounded",children:[e.jsxs("p",{className:"text-sm text-blue-200",children:[e.jsx("strong",{children:"Ready to continue:"})," ",P.size," / ",((fe=t==null?void 0:t.partyMembers)==null?void 0:fe.filter(s=>s.hp>0).length)||0," party members"]}),P.size>0&&e.jsxs("div",{className:"mt-2 text-xs text-blue-300",children:["Waiting for: ",((ve=(je=(ye=t==null?void 0:t.partyMembers)==null?void 0:ye.filter(s=>s.hp>0&&!P.has(s.userId)))==null?void 0:je.map(s=>s.name))==null?void 0:ve.join(", "))||"None"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center items-center",children:[e.jsx("button",{onClick:Ve,disabled:!g&&P.has(x==null?void 0:x.uid),className:`fantasy-button px-8 py-3 text-lg font-semibold ${!g&&P.has(x==null?void 0:x.uid)?"bg-green-700 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 shadow-lg"}`,children:!g&&P.has(x==null?void 0:x.uid)?"✓ Ready":"Confirm"}),g&&e.jsx("button",{onClick:()=>{G(!1),K(new Set),A()},className:"fantasy-button px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white",children:"Skip Confirmation"})]}),e.jsx("div",{className:"mt-4 p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:e.jsxs("p",{className:"text-sm text-yellow-200",children:[e.jsx("strong",{children:"Note:"})," Review the battle log and enemy actions before continuing to the next turn."]})})]})}),E&&!F&&e.jsx("div",{className:"fantasy-card bg-amber-900/20 border-amber-700",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-amber-500"}),e.jsx("span",{className:"ml-2 text-amber-300 font-medium",children:"Processing turn..."})]})}),(t==null?void 0:t.combatState)==="ready"&&!Be&&e.jsx("div",{className:"fantasy-card bg-red-900/20 border-red-700",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h4",{className:"font-bold text-red-300 mb-4 text-2xl",children:"⚔️ Combat Ready!"}),e.jsx("p",{className:"text-red-200 mb-6 text-lg",children:"All combatants are in position. Click 'Fight!' to begin the battle."}),e.jsx("button",{onClick:qe,disabled:E,className:"fantasy-button px-12 py-4 text-xl font-bold bg-red-600 hover:bg-red-700 shadow-lg",children:E?"Preparing...":"Fight!"})]})})]}),e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsx(jt,{combatants:B,currentCombatant:Q}),V.length>0&&e.jsxs("div",{className:"fantasy-card",children:[e.jsx("h3",{className:"font-bold text-blue-300 mb-2 text-sm",children:"🌍 Environment"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:V.map((s,a)=>e.jsx("span",{className:"px-2 py-1 bg-blue-900 text-blue-200 rounded text-xs",children:s},a))})]}),X.length>0&&e.jsxs("div",{className:"fantasy-card",children:[e.jsx("h3",{className:"font-bold text-purple-300 mb-2 text-sm",children:"🤝 Team Up"}),e.jsx("div",{className:"space-y-1",children:X.map((s,a)=>e.jsxs("div",{className:"text-purple-200 text-xs",children:[e.jsxs("strong",{children:[s.classes.join("+"),":"]})," ",s.description]},a))})]}),Fe&&J&&e.jsx("div",{className:"fixed inset-0 pointer-events-none z-50 flex items-center justify-center",children:e.jsxs("div",{className:`text-6xl font-bold animate-bounce px-6 py-4 rounded-lg shadow-lg ${J.type==="damage"?"text-red-400 bg-red-900/80":"text-green-400 bg-green-900/80"}`,children:[J.type==="damage"?"-":"+",J.damage]})}),ue&&$&&e.jsx("div",{className:"fantasy-card bg-red-900/20 border-red-700",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"💀"}),e.jsx("h1",{className:"text-3xl font-bold text-red-300 mb-4",children:"Character Death"}),e.jsxs("div",{className:"text-xl text-red-200 mb-6",children:[$.name," has fallen in battle..."]}),e.jsxs("div",{className:"bg-gray-700 p-6 rounded-lg border border-red-600 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-100 mb-2",children:"Fallen Hero"}),e.jsxs("p",{className:"text-gray-300 mb-2",children:[e.jsx("strong",{children:"Name:"})," ",$.name]}),e.jsxs("p",{className:"text-gray-300 mb-2",children:[e.jsx("strong",{children:"Class:"})," ",$.class]}),e.jsxs("p",{className:"text-gray-300 mb-2",children:[e.jsx("strong",{children:"Level:"})," ",$.level]}),e.jsxs("p",{className:"text-gray-300",children:[e.jsx("strong",{children:"Final HP:"})," ",$.hp,"/",$.maxHp]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-gray-300",children:"Your character has been defeated. You must create a new character to continue."}),e.jsx("button",{onClick:Ke,className:"fantasy-button bg-red-600 hover:bg-red-700",children:"Create New Character"})]})]})})]})]})]})})}export{$t as default};
