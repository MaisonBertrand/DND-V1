import{r as x,F as Fe,s as He,C as Ue,G as ze,H as Be,I as Ye,J as be,K as Ge,M as L,N as qe,O as _e,j as e,d as Ve,q as We,u as Ze,R as xe}from"./index-c208d5f4.js";import{m as ve}from"./manualCombat-33808f22.js";import{c as me}from"./combatService-f27cbddc.js";const z={INVESTIGATION:"investigation",COMBAT:"combat",PERSUASION:"persuasion",EXPLORATION:"exploration",SOCIAL:"social"},B={HIDDEN:"hidden",DISCOVERED:"discovered",IN_PROGRESS:"in_progress",COMPLETED:"completed",FAILED:"failed"},Ke=i=>{const n=[{id:"investigate_area",type:z.INVESTIGATION,title:"Investigate the Area",description:"Search for clues and gather information about the situation",keywords:["search","investigate","examine","look around","check","explore"],state:B.HIDDEN,discoveredAt:null,completedAt:null},{id:"resolve_conflict",type:z.COMBAT,title:"Resolve the Conflict",description:"Engage in combat to overcome the threat",keywords:["fight","attack","defend","combat","battle"],state:B.HIDDEN,discoveredAt:null,completedAt:null},{id:"negotiate_peace",type:z.PERSUASION,title:"Negotiate Peace",description:"Use diplomacy and persuasion to resolve the situation peacefully",keywords:["talk","negotiate","persuade","convince","diplomacy","peace"],state:B.HIDDEN,discoveredAt:null,completedAt:null}],s=[];return(i.toLowerCase().includes("thief")||i.toLowerCase().includes("stealth"))&&s.push({id:"stealth_approach",type:z.EXPLORATION,title:"Stealth Approach",description:"Use stealth to avoid detection and gather information",keywords:["sneak","stealth","hide","silent","unnoticed"],state:B.HIDDEN,discoveredAt:null,completedAt:null}),(i.toLowerCase().includes("merchant")||i.toLowerCase().includes("trade"))&&s.push({id:"establish_trade",type:z.SOCIAL,title:"Establish Trade Relations",description:"Build economic relationships with the locals",keywords:["trade","bargain","deal","commerce","business"],state:B.HIDDEN,discoveredAt:null,completedAt:null}),(i.toLowerCase().includes("scholar")||i.toLowerCase().includes("knowledge"))&&s.push({id:"gather_knowledge",type:z.INVESTIGATION,title:"Gather Ancient Knowledge",description:"Discover and preserve valuable information",keywords:["research","study","learn","knowledge","ancient","lore"],state:B.HIDDEN,discoveredAt:null,completedAt:null}),[...n,...s]};class ye{constructor(){this.diceService=ve,this.storyRules={redirectPatterns:[{pattern:/\b(?:i\s+)?(?:do|perform|execute)\s+\d+\s+(?:backflips?|somersaults?|cartwheels?)\b/gi,response:"While impressive acrobatics are possible, let's focus on actions that advance the story. What's your main goal here?",suggestion:"Try describing a more focused action that helps with the current situation."},{pattern:/\b(?:i\s+)?(?:fly|levitate|float)\s+(?:to|up|over|across)\b/gi,response:"Flight isn't currently possible in this situation. What are you trying to achieve?",suggestion:"Consider climbing, jumping, or finding another way to reach your destination."},{pattern:/\b(?:i\s+)?(?:grab|take|steal)\s+(?:the\s+)?(?:quest\s+item|treasure|artifact)\s+(?:from\s+)?(?:nowhere|thin\s+air)\b/gi,response:"The quest item isn't just lying around. You'll need to find it through exploration and investigation.",suggestion:"Try searching the area, asking NPCs, or following clues to locate the item."},{pattern:/\b(?:i\s+)?(?:attack|kill|destroy)\s+(?:everyone|all|each)\s+(?:enemy|person|creature)\b/gi,response:"While combat is possible, attacking everyone at once isn't practical. Let's focus on the immediate threat.",suggestion:"Choose a specific target or describe a more strategic approach."}],expandPatterns:[{pattern:/\b(?:i\s+)?(?:search|look|examine)\b/gi,response:"What specifically are you searching for or looking at?",suggestion:"Be more specific about what you're searching for or examining."},{pattern:/\b(?:i\s+)?(?:talk|speak|ask)\b/gi,response:"Who would you like to talk to, and what would you like to discuss?",suggestion:"Specify the person and topic of conversation."},{pattern:/\b(?:i\s+)?(?:go|move|walk)\b/gi,response:"Where would you like to go?",suggestion:"Specify your destination or direction."}],encouragePatterns:[{pattern:/\b(?:i\s+)?(?:investigate|explore|examine)\b/gi,response:"Great! Investigation and exploration are key to advancing the story.",suggestion:"What specific aspect would you like to investigate?"},{pattern:/\b(?:i\s+)?(?:help|assist|aid)\b/gi,response:"Helping others is always a noble choice. Who would you like to help?",suggestion:"Specify who needs help and how you can assist them."},{pattern:/\b(?:i\s+)?(?:negotiate|diplomacy|peace)\b/gi,response:"Diplomacy can often achieve more than violence. Good thinking!",suggestion:"How would you like to approach the negotiation?"}]},this.contextResponses={combat:{impossible:"That action isn't possible in combat. Focus on your available combat options.",difficult:"That's a challenging action in combat. Are you sure you want to attempt it?",strategic:"That's a good strategic choice. How do you want to execute it?"},exploration:{impossible:"That action doesn't make sense in this environment. What are you trying to achieve?",difficult:"That will be challenging given the current circumstances.",strategic:"That's a good approach to exploration. Let's see how it goes."},social:{impossible:"That action isn't appropriate in this social situation.",difficult:"That's a bold social move. Are you prepared for the consequences?",strategic:"That's a good approach to the situation. How do you want to proceed?"}}}validatePlayerAction(n,s,t={}){const a=n.toLowerCase(),o=this.checkImpossibleActions(a);if(!o.possible)return{valid:!1,type:"impossible",response:o.response,suggestion:o.suggestion,diceResult:null};const l=this.checkRedirectPatterns(a);if(l.needsRedirect)return{valid:!1,type:"redirect",response:l.response,suggestion:l.suggestion,diceResult:null};const r=this.checkExpandPatterns(a);if(r.needsExpansion)return{valid:!1,type:"expand",response:r.response,suggestion:r.suggestion,diceResult:null};const c=this.diceService.validateAction(n,s,t);return{valid:!0,type:"valid",response:this.generateValidationResponse(c,s,t),suggestion:c.suggestion,diceResult:c}}checkImpossibleActions(n){for(const s of this.diceService.impossibleActionPatterns)if(s.test(n))return{possible:!1,response:"That action is beyond the realm of possibility in this world.",suggestion:"Try a more realistic approach that fits within the story and your character's abilities."};return{possible:!0}}checkRedirectPatterns(n){for(const s of this.storyRules.redirectPatterns)if(s.pattern.test(n))return{needsRedirect:!0,response:s.response,suggestion:s.suggestion};return{needsRedirect:!1}}checkExpandPatterns(n){for(const s of this.storyRules.expandPatterns)if(s.pattern.test(n))return{needsExpansion:!0,response:s.response,suggestion:s.suggestion};return{needsExpansion:!1}}generateValidationResponse(n,s,t){if(!n.overallSuccess)return n.actions.filter(c=>!c.check.isSuccess).filter(c=>c.check.degree==="critical failure").length>0?`The actions you described are beyond your current capabilities. ${n.suggestion}`:`The actions you described are challenging but possible. ${n.suggestion}`;const a=this.generateAtmosphericResponse(n,s,t),o=this.extractEntities(a,t);return{story:a,entities:o}}generateAtmosphericResponse(n,s,t){const{actions:a,overallSuccess:o,hasCriticalFailures:l}=n,r=t==null?void 0:t.customContext;let c=this.getAtmosphericElements(r),m=this.calculateTensionLevel(a,l),p="";return a.length===1?p=this.generateSingleActionResponse(a[0],s,c,m):p=this.generateMultiActionResponse(a,s,c,m),r&&r.environmentalFeatures&&(p+=this.addEnvironmentalDetails(r.environmentalFeatures,m)),r&&r.npcs&&(p+=this.addNPCReactions(r.npcs,a,o)),p+=this.addStoryProgressionHook(a,m,r),p}getAtmosphericElements(n){const s={lighting:"dim",weather:"calm",mood:"neutral",tension:"low"};if(!n)return s;const t=n.description.toLowerCase();return(t.includes("dark")||t.includes("shadow"))&&(s.lighting="dark"),(t.includes("bright")||t.includes("sunlight"))&&(s.lighting="bright"),(t.includes("dim")||t.includes("flickering"))&&(s.lighting="dim"),(t.includes("storm")||t.includes("rain"))&&(s.weather="stormy"),(t.includes("fog")||t.includes("mist"))&&(s.weather="foggy"),t.includes("wind")&&(s.weather="windy"),(t.includes("tension")||t.includes("danger"))&&(s.mood="tense"),(t.includes("peaceful")||t.includes("calm"))&&(s.mood="peaceful"),(t.includes("eerie")||t.includes("creepy"))&&(s.mood="eerie"),s}calculateTensionLevel(n,s){let t="low";const a=n.filter(o=>["attack","spell","dodge","parry"].includes(o.action));return a.length>0&&(t="medium"),a.length>2&&(t="high"),s&&(t="critical"),t}generateSingleActionResponse(n,s,t,a){const{action:o,check:l,keyword:r}=n,c=l.isSuccess;l.degree;const m={attack:{success:{low:`${s.name} strikes true, the blow landing with satisfying impact.`,medium:`${s.name}'s weapon finds its mark, the strike ringing out in the ${t.lighting} light.`,high:`${s.name} delivers a devastating blow, the force of the attack echoing through the ${t.weather} air.`,critical:`${s.name} executes a perfect strike, the precision of the attack leaving no room for error.`},failure:{low:`${s.name} swings wide, the attack missing its intended target.`,medium:`${s.name}'s strike goes awry, the weapon clattering against stone or wood.`,high:`${s.name} completely misses, the failed attack leaving them momentarily vulnerable.`,critical:`${s.name} stumbles in their attack, the botched strike nearly causing them to fall.`}},backflip:{success:{low:`${s.name} executes a graceful backflip, landing softly on their feet.`,medium:`${s.name} performs an impressive backflip, the acrobatic feat drawing attention.`,high:`${s.name} completes a spectacular backflip, the display of agility leaving onlookers amazed.`,critical:`${s.name} achieves a flawless backflip, the perfect form and landing drawing gasps of admiration.`},failure:{low:`${s.name} attempts a backflip but loses balance, stumbling slightly.`,medium:`${s.name} fails the backflip, landing awkwardly and looking embarrassed.`,high:`${s.name} completely botches the backflip, falling hard to the ground.`,critical:`${s.name} crashes spectacularly during the backflip, potentially injuring themselves.`}},search:{success:{low:`${s.name} searches carefully, their trained eyes picking up subtle details.`,medium:`${s.name} conducts a thorough search, methodically examining every corner.`,high:`${s.name} performs an exhaustive search, their attention to detail revealing hidden secrets.`,critical:`${s.name} discovers something extraordinary, their keen observation uncovering a crucial clue.`},failure:{low:`${s.name} looks around but finds nothing of interest.`,medium:`${s.name} searches but misses several obvious details.`,high:`${s.name} fails to notice important clues, their search proving fruitless.`,critical:`${s.name} overlooks critical information, their poor search skills costing them dearly.`}},persuade:{success:{low:`${s.name} makes a reasonable argument, their words carrying some weight.`,medium:`${s.name} presents a compelling case, their charisma swaying the listener.`,high:`${s.name} delivers a masterful persuasion, their words impossible to ignore.`,critical:`${s.name} achieves the impossible, their silver tongue turning enemies into allies.`},failure:{low:`${s.name} tries to persuade but fails to make a convincing argument.`,medium:`${s.name}'s attempt at persuasion falls flat, their words lacking impact.`,high:`${s.name} completely fails to persuade, their poor communication skills evident.`,critical:`${s.name} not only fails to persuade but manages to offend the listener.`}}},p=m[o]||m.attack,u=c?"success":"failure",d=a==="critical"?"high":a;return p[u][d]}generateMultiActionResponse(n,s,t,a){const o=n.length,l=n.filter(c=>c.check.isSuccess).length,r=o-l;return l===o?`${s.name} executes a flawless sequence of actions, each movement flowing seamlessly into the next. The display of skill and coordination is impressive to behold.`:l>r?`${s.name} performs admirably, with most actions succeeding despite the challenging circumstances. A few missteps don't diminish the overall effectiveness.`:r>l?`${s.name} struggles with the complex sequence, many actions failing to achieve their intended results. The difficulty of the task proves overwhelming.`:`${s.name} has mixed results, with some actions succeeding while others fail. The outcome remains uncertain.`}addEnvironmentalDetails(n,s){if(n.length===0)return"";const t={dark:{low:" The darkness seems to swallow sound, making every movement feel more significant.",medium:" Shadows dance in the darkness, creating an atmosphere of uncertainty.",high:" The oppressive darkness makes every action feel more dangerous and urgent.",critical:" The pitch-black environment amplifies every sound, every movement potentially deadly."},stormy:{low:" Rain patters against surfaces, adding a rhythmic backdrop to the scene.",medium:" The storm intensifies, wind and rain making movement more challenging.",high:" The raging storm creates a chaotic environment where every action is a gamble.",critical:" The violent storm threatens to overwhelm all but the most determined efforts."},foggy:{low:" Mist swirls gently, obscuring distant details.",medium:" The fog thickens, reducing visibility and creating an eerie atmosphere.",high:" Dense fog makes navigation difficult and every shadow a potential threat.",critical:" The impenetrable fog isolates you completely, each step into the unknown."}};let a="";return n.forEach(o=>{t[o]&&(a+=t[o][s]||"")}),a}addNPCReactions(n,s,t){if(n.length===0)return"";const a=n.map(o=>o.name).join(" and ");return t?` ${a} watch with growing interest, clearly impressed by your actions.`:` ${a} exchange concerned glances, their confidence in your abilities wavering.`}addStoryProgressionHook(n,s,t){const a=n.some(r=>["attack","spell","dodge","parry"].includes(r.action)),o=n.some(r=>["search","climb","jump"].includes(r.action)),l=n.some(r=>["persuade","intimidate","deceive"].includes(r.action));return a&&s==="high"?" The tension in the air is palpable. Something is about to happen...":o?" Your investigation reveals new possibilities. What will you discover next?":l?" The social dynamics shift with your words. How will others respond?":" The situation continues to unfold. What will you do next?"}generateStoryResponse(n,s,t={}){const a=this.validatePlayerAction(n,s,t);if(!a.valid)return{response:a.response,suggestion:a.suggestion,shouldProceed:!1,diceResult:null};const o=[];return a.diceResult.actions&&a.diceResult.actions.forEach(l=>{const r=this.diceService.generateActionNarrative(l.check,s);o.push(r)}),{response:o.join(" "),suggestion:a.suggestion,shouldProceed:!0,diceResult:a.diceResult}}handleComplexAction(n,s,t={}){const a=this.diceService.extractActionsFromDescription(n.toLowerCase());if(a.length===0)return{response:"I understand your intent. Let's see how this plays out in the story.",shouldProceed:!0,type:"narrative"};if(a.length===1)return this.generateStoryResponse(n,s,t);const o=this.diceService.performActionSequence(s,a,t);return o.overallSuccess?{response:o.actions.map(r=>this.diceService.generateActionNarrative(r.check,s)).join(" "),shouldProceed:!0,type:"sequence",diceResult:o}:o.actions.filter(c=>!c.check.isSuccess).filter(c=>c.check.degree==="critical failure").length>0?{response:"The sequence of actions you described is too complex for your current abilities. Try breaking it down into simpler steps.",shouldProceed:!1,type:"sequence_failure",diceResult:o}:{response:"Some parts of your action sequence are challenging. You might want to simplify your approach.",shouldProceed:!1,type:"sequence_partial",diceResult:o}}provideAlternatives(n,s,t={}){const a=n.toLowerCase(),o=[];return(a.includes("backflip")||a.includes("somersault"))&&o.push({action:"dodge",description:"Try dodging or evading instead of acrobatics",difficulty:"easier"}),(a.includes("fly")||a.includes("levitate"))&&o.push({action:"climb",description:"Try climbing or finding another way up",difficulty:"realistic"}),a.includes("attack everyone")&&o.push({action:"focus",description:"Focus on one target at a time for better effectiveness",difficulty:"strategic"}),a.includes("grab quest item")&&o.push({action:"search",description:"Search the area thoroughly to find the item",difficulty:"appropriate"}),o}maintainStoryCoherence(n,s,t){const a={storyPhase:this.checkStoryPhase(n,s),establishedFacts:this.checkEstablishedFacts(n,s),plotAdvancement:this.checkPlotAdvancement(n,s),characterDevelopment:this.checkCharacterDevelopment(n,t)},o=Object.entries(a).filter(([l,r])=>!r.valid).map(([l,r])=>r.issue);return{coherent:o.length===0,issues:o,suggestions:this.generateCoherenceSuggestions(o,s)}}checkStoryPhase(n,s){const t=s.phase||"exploration",a=n.toLowerCase(),r=({introduction:["attack","kill","destroy"],exploration:["end quest","skip to boss"],combat:["negotiate peace","run away"],resolution:["start new quest","begin adventure"]}[t]||[]).some(c=>a.includes(c));return{valid:!r,issue:r?`This action doesn't fit the current story phase (${t})`:null}}checkEstablishedFacts(n,s){const t=s.establishedFacts||[],a=n.toLowerCase();for(const o of t)if(o.contradicts&&o.contradicts.some(l=>a.includes(l.toLowerCase())))return{valid:!1,issue:`This action contradicts established story facts: ${o.description}`};return{valid:!0}}checkPlotAdvancement(n,s){const t=s.plotPoints||[],a=n.toLowerCase(),o=t.find(l=>l.active);return o&&o.keywords&&!o.keywords.some(r=>a.includes(r.toLowerCase()))?{valid:!1,issue:"This action doesn't address the current plot point"}:{valid:!0}}checkCharacterDevelopment(n,s){const t=s.alignment||"Neutral",a=n.toLowerCase(),r=({"Lawful Good":["steal","deceive","harm innocent"],"Chaotic Evil":["help others","follow rules","show mercy"],"Neutral Good":["harm innocent","betray allies"],"Lawful Evil":["break laws","show mercy","help weak"],"Chaotic Good":["follow strict rules","harm innocent"],"True Neutral":["take extreme actions","show strong emotions"],"Lawful Neutral":["break laws","show mercy","act chaotically"],"Neutral Evil":["help others","follow laws","show mercy"],"Chaotic Neutral":["follow strict rules","show strong loyalty"]}[t]||[]).some(c=>a.includes(c));return{valid:!r,issue:r?`This action doesn't align with your character's alignment (${t})`:null}}generateCoherenceSuggestions(n,s){const t=[];return n.forEach(a=>{a.includes("story phase")?t.push("Consider actions that fit the current phase of the story."):a.includes("established facts")?t.push("Remember what has already been established in the story."):a.includes("plot point")?t.push("Focus on actions that advance the current plot."):a.includes("alignment")&&t.push("Consider actions that align with your character's moral compass.")}),t}extractEntities(n,s={}){const t={enemies:[],items:[],locations:[],statusEffects:[],questHooks:[],npcs:[]};return n.toLowerCase(),[/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:the\s+)?(?:priest|wizard|mage|sorcerer|warlock|necromancer|lich|vampire|werewolf|ghost|spirit|demon|devil|fiend|beast|creature|monster|boss|mini-boss)/gi,/\b(goblin|orc|troll|dragon|bandit|skeleton|zombie|ghost|spirit|demon|devil|fiend|beast|creature|monster)\b/gi,/(?:mini-boss|boss)\s*[–-]\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/gi,/\[Combat\s+Trigger[^]]*[–-]\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\]/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[1]||u[0];d&&!t.enemies.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.enemies.push({name:d,type:"enemy",subtype:this.determineEnemySubtype(d,n),status:this.determineEnemyStatus(d,n)})}}),[/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:of\s+[A-Z][a-z]+)/gi,/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:sword|dagger|staff|wand|scroll|potion|ring|amulet|crown|robe|armor|shield)/gi,/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:cursed|forbidden|ancient|legendary)/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[1]||u[0];d&&!t.items.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.items.push({name:d,type:"item",subtype:this.determineItemSubtype(d,n),status:this.determineItemStatus(d,n)})}}),[/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:shrine|temple|castle|tower|dungeon|cave|tunnel|chamber|room|hall|garden|forest|mountain|river|lake|ocean|tavern|inn)/gi,/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:cliffs|beach|island|valley|peak|summit|depths|heights)/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[1]||u[0];d&&!t.locations.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.locations.push({name:d,type:"location",subtype:this.determineLocationSubtype(d,n),tags:this.determineLocationTags(d,n)})}}),[/(?:cursed|blessed|enchanted|poisoned|paralyzed|charmed|frightened|invisible|ethereal|ethereal|flying|levitating)/gi,/(?:in\s+darkness|in\s+bright\s+light|under\s+pressure|in\s+a\s+hurry|carefully|stealthily|aggressively|defensively)/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[0];d&&!t.statusEffects.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.statusEffects.push({name:d,type:"status_effect",effect:this.determineStatusEffect(d,n)})}}),[/(?:break|destroy|find|retrieve|defeat|save|protect|escort|investigate|explore)\s+(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/gi,/(?:quest|mission|objective|goal|task|duty|responsibility)/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[1]||u[0];d&&!t.questHooks.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.questHooks.push({name:d,type:"quest_hook",objective:this.determineQuestObjective(d,n)})}}),[/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:merchant|trader|noble|lord|lady|king|queen|prince|princess|mayor|priest|shaman|hunter|fisherman|farmer)/gi,/(?:the\s+)?([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:quest\s+giver|guide|mentor|teacher|master)/gi].forEach(p=>{let u;for(;(u=p.exec(n))!==null;){const d=u[1]||u[0];d&&!t.npcs.some(f=>f.name.toLowerCase()===d.toLowerCase())&&t.npcs.push({name:d,type:"npc",role:this.determineNPCRole(d,n),disposition:"friendly"})}}),t}determineEnemySubtype(n,s){s.toLowerCase();const t=n.toLowerCase();return t.includes("boss")||t.includes("mini-boss")?"boss":t.includes("priest")||t.includes("cleric")?"priest":t.includes("wizard")||t.includes("mage")?"wizard":t.includes("dragon")?"dragon":t.includes("undead")||t.includes("skeleton")||t.includes("zombie")?"undead":t.includes("goblin")||t.includes("orc")||t.includes("troll")?"monster":"enemy"}determineEnemyStatus(n,s){const t=s.toLowerCase();return t.includes("snarls")||t.includes("aggressive")?"hostile":t.includes("defensive")||t.includes("cautious")?"defensive":t.includes("chanting")||t.includes("casting")?"casting":"active"}determineItemSubtype(n,s){const t=n.toLowerCase();return t.includes("sword")||t.includes("dagger")||t.includes("staff")?"weapon":t.includes("potion")||t.includes("scroll")?"consumable":t.includes("ring")||t.includes("amulet")||t.includes("crown")?"accessory":t.includes("armor")||t.includes("robe")||t.includes("shield")?"armor":"item"}determineItemStatus(n,s){const t=s.toLowerCase(),a=n.toLowerCase();return a.includes("cursed")||t.includes("cursed")?"cursed":a.includes("forbidden")||t.includes("forbidden")?"forbidden":a.includes("ancient")||t.includes("ancient")?"ancient":a.includes("legendary")||t.includes("legendary")?"legendary":t.includes("magical")||t.includes("enchanted")?"magical":"normal"}determineLocationSubtype(n,s){const t=n.toLowerCase();return t.includes("shrine")||t.includes("temple")?"religious":t.includes("castle")||t.includes("tower")?"fortification":t.includes("cave")||t.includes("tunnel")?"underground":t.includes("forest")||t.includes("garden")?"natural":t.includes("tavern")||t.includes("inn")?"settlement":"location"}determineLocationTags(n,s){const t=[],a=s.toLowerCase();return(a.includes("ancient")||a.includes("old"))&&t.push("ancient"),(a.includes("dangerous")||a.includes("hostile"))&&t.push("dangerous"),(a.includes("sacred")||a.includes("holy"))&&t.push("sacred"),(a.includes("cursed")||a.includes("evil"))&&t.push("cursed"),(a.includes("coastal")||a.includes("ocean"))&&t.push("coastal"),(a.includes("mountain")||a.includes("high"))&&t.push("mountainous"),t}determineStatusEffect(n,s){const t=n.toLowerCase();return t.includes("cursed")?"disables healing":t.includes("poisoned")?"damage over time":t.includes("paralyzed")?"prevents movement":t.includes("charmed")?"mind control":t.includes("invisible")?"stealth bonus":t.includes("flying")?"flight ability":"unknown effect"}determineQuestObjective(n,s){const t=n.toLowerCase();return t.includes("break")||t.includes("destroy")?"destruction":t.includes("find")||t.includes("retrieve")?"retrieval":t.includes("defeat")||t.includes("kill")?"combat":t.includes("save")||t.includes("protect")?"protection":t.includes("escort")?"escort":t.includes("investigate")||t.includes("explore")?"exploration":"objective"}determineNPCRole(n,s){const t=n.toLowerCase();return t.includes("merchant")||t.includes("trader")?"merchant":t.includes("noble")||t.includes("lord")||t.includes("lady")?"noble":t.includes("king")||t.includes("queen")?"royalty":t.includes("priest")||t.includes("shaman")?"religious":t.includes("quest giver")||t.includes("guide")?"quest_giver":"npc"}}const Xe=new ye,Qe="https://dnd-v1-backend.onrender.com",T=async(i,n="gpt-4",s=1e3,t=.8)=>{try{const a=i.filter(r=>!r||typeof r!="object"?(console.warn("Invalid message object:",r),!1):!r.role||!r.content?(console.warn("Message missing role or content:",r),!1):!0);if(a.length===0)throw new Error("No valid messages to send to API");const o=await fetch(`${Qe}/api/openai`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:a,model:n,max_tokens:s,temperature:t})});if(!o.ok){let r="Backend API request failed";try{r=(await o.json()).error||r}catch{r=`${o.status}: ${o.statusText}`}throw o.status===500?r=`AI service error: ${r}. This might be due to missing API key, rate limiting, or network issues.`:o.status===404?r="AI service endpoint not found. Please check the backend configuration.":o.status===503&&(r="AI service temporarily unavailable. Please try again later."),new Error(r)}return await o.json()}catch(a){throw console.error("Backend API Error:",a),new Error(`Failed to communicate with backend: ${a.message}`)}};class Je{constructor(){this.systemPrompt=`You are an experienced Dungeon Master for Dungeons & Dragons 5th Edition. You excel at:
- Creating engaging storylines and plot hooks
- Developing detailed character descriptions and backstories
- Generating multiple story options when specifically requested
- Providing atmospheric descriptions and immersive storytelling
- Balancing combat encounters and managing game mechanics
- Creating memorable NPCs and villains
- Adapting to player choices and creating dynamic narratives
- Maintaining story consistency and character development
- Building upon established relationships and plot threads

IMPORTANT: Only generate multiple options when explicitly requested. When asked to generate a single story introduction, campaign goal, or other content, provide ONLY ONE response.

Always respond in character as a Dungeon Master, providing rich, descriptive content that enhances the gaming experience. Maintain consistency with previous story elements, character relationships, and established plot threads.`,this.diceService=ve,this.actionValidationService=new ye,this.combatService=me}async generateStoryPlots(n,s="",t=null){try{const a=n.map(c=>`${c.name} - Level ${c.level} ${c.race} ${c.class} (${c.alignment})`).join(", ");let o="";t&&(o=`
Party Theme: ${t.description||"No theme provided"}`);const l=`As a Dungeon Master, I need you to generate 3 different story plot options for a D&D campaign.

Party Composition: ${a}${o}
Campaign Setting: ${s||"Generic fantasy world"}

IMPORTANT: You MUST format your response EXACTLY as follows for each plot option:

**Plot Option 1:**
1. Title: "[Plot Title Here]"
2. Summary: [2-3 sentence summary of the plot]
3. Main Conflict: [The main challenge or conflict the party will face]
4. Story Hooks: [How the party gets involved and what motivates them]
5. Estimated Campaign Length: [short/medium/long]

**Plot Option 2:**
1. Title: "[Plot Title Here]"
2. Summary: [2-3 sentence summary of the plot]
3. Main Conflict: [The main challenge or conflict the party will face]
4. Story Hooks: [How the party gets involved and what motivates them]
5. Estimated Campaign Length: [short/medium/long]

**Plot Option 3:**
1. Title: "[Plot Title Here]"
2. Summary: [2-3 sentence summary of the plot]
3. Main Conflict: [The main challenge or conflict the party will face]
4. Story Hooks: [How the party gets involved and what motivates them]
5. Estimated Campaign Length: [short/medium/long]

Guidelines for the plots:
- Use the party theme to influence the plot lines and atmosphere
- Incorporate themes and elements from the party theme to create a cohesive narrative
- Consider how the party's background and composition might influence the plot
- Make each plot distinct and appealing to different play styles
- Focus on the characters and their individual stories

CRITICAL: Do not deviate from this exact format. Each plot must start with "**Plot Option X:**" and use the numbered format exactly as shown above.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:l}],"gpt-4",1e3,.8)).choices[0].message.content}catch(a){throw new Error(`Failed to generate story plots: ${a.message}`)}}async generateCharacterDetails(n){try{const s=`As a Dungeon Master, I need you to expand on this character's details and create a rich, detailed description.

Character: ${n.name} - Level ${n.level} ${n.race} ${n.class}
Background: ${n.background}
Alignment: ${n.alignment}
Personality: ${n.personality||"Not specified"}
Ideals: ${n.ideals||"Not specified"}
Bonds: ${n.bonds||"Not specified"}
Flaws: ${n.flaws||"Not specified"}
Backstory: ${n.backstory||"Not specified"}

Please provide:
1. A detailed physical description (appearance, mannerisms, distinctive features)
2. An expanded personality profile with quirks and habits
3. A deeper backstory with key events and relationships
4. Character motivations and goals
5. Potential story hooks and plot threads related to this character
6. How this character might interact with the party and world

Make the character feel alive and three-dimensional, with details that could drive story development.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:s}],"gpt-4",800,.7)).choices[0].message.content}catch(s){throw console.error("Error generating character details:",s),new Error(`Failed to generate character details: ${s.message}`)}}async generateStorySummary(n,s){try{const t=s.map(l=>`${l.name} (${l.race} ${l.class})`).join(", "),a=`As a Dungeon Master, I need you to create a detailed story summary and outline for this campaign plot.

Plot: ${n}
Party: ${t}

Please provide:
1. A detailed campaign overview (3-4 paragraphs)
2. Key story beats and major events
3. Important NPCs and their roles
4. Potential challenges and obstacles
5. Story themes and motifs
6. How each party member might be personally invested
7. Potential branching paths and player choices
8. Climactic moments and resolution possibilities

Make this feel like a professional campaign module with rich storytelling potential.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:a}],"gpt-4",1200,.7)).choices[0].message.content}catch(t){throw console.error("Error generating story summary:",t),new Error(`Failed to generate story summary: ${t.message}`)}}async generateMultipleStoryPlots(n,s="",t=null){try{const a=n.map(c=>`${c.name} - Level ${c.level} ${c.race} ${c.class} (${c.alignment})`).join(", ");let o="";t&&(o=`
Party Theme: ${t.description||"No theme provided"}`);const l=`As a Dungeon Master, I need you to generate 5 different story plot options for a D&D campaign, each with a detailed summary.

Party Composition: ${a}${o}
Campaign Setting: ${s||"Generic fantasy world"}

For each of the 5 plot options, provide:
1. A compelling title
2. A detailed summary (3-4 paragraphs)
3. The main conflict or challenge
4. Key story beats and major events
5. Important NPCs and their roles
6. Potential story hooks for the party
7. Estimated campaign length (short, medium, or long)
8. Themes and motifs
9. How each party member might be personally invested

Important Guidelines:
- Use the party theme to influence the plot lines and atmosphere
- Incorporate themes and elements from the party theme to create a cohesive narrative
- Consider how the party's background and composition might influence the plot
- Make each plot distinct and appealing to different play styles
- Focus on the characters and their individual stories

Make each plot distinct and appealing to different play styles. Consider the party composition when crafting these options. Number each plot clearly (Plot 1, Plot 2, etc.).`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:l}],"gpt-4",1500,.8)).choices[0].message.content}catch(a){throw console.error("Error generating multiple story plots:",a),new Error(`Failed to generate multiple story plots: ${a.message}`)}}async generateNPC(n,s=""){try{const t=`As a Dungeon Master, I need you to create a detailed NPC for this role and context.

NPC Role: ${n}
Context: ${s||"General campaign context"}

Please provide:
1. A detailed physical description
2. Personality traits and mannerisms
3. Background and motivations
4. Current situation and goals
5. How they might interact with the party
6. Potential story hooks or plot threads they could introduce
7. Their relationship to the world and other NPCs
8. Any secrets or hidden aspects of their character

Make this NPC feel like a real person with depth and complexity.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:t}],"gpt-4",800,.7)).choices[0].message.content}catch(t){throw console.error("Error generating NPC:",t),new Error(`Failed to generate NPC: ${t.message}`)}}async generateCombatEncounter(n,s,t="medium",a=""){try{const o=`As a Dungeon Master, I need you to create a detailed combat encounter.

Party Level: ${n}
Party Size: ${s}
Difficulty: ${t}
Theme: ${a||"General fantasy"}

Please provide:
1. A detailed description of the encounter location
2. Enemy types and their motivations
3. Tactical considerations and terrain features
4. Potential story elements or plot hooks
5. Non-combat resolution options
6. Consequences of victory or defeat
7. Environmental hazards or advantages
8. How this encounter fits into the larger story

Make this encounter feel meaningful and story-driven, not just a random fight.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:o}],"gpt-4",800,.7)).choices[0].message.content}catch(o){throw console.error("Error generating combat encounter:",o),new Error(`Failed to generate combat encounter: ${o.message}`)}}async generateStoryContinuation(n,s,t,a=null,o="individual",l=null){var r,c,m,p,u;try{const d=n.map(b=>`${b.name} - Level ${b.level} ${b.race} ${b.class}`).join(", ");let f=null,y=null,j="";if(o==="individual"){const b=n[n.length-1];if(b)if(f=this.actionValidationService.validatePlayerAction(t,b,{context:"story",storyState:a}),f.valid&&f.diceResult){if(y=f.diceResult,y.overallSuccess){if(j=`

ACTION VALIDATION: The action is within your character's capabilities.`,y.actions){const P=y.actions.map($=>`${$.action}: ${$.check.isSuccess?"Success":"Failure"} (Roll: ${$.check.roll}, DC: ${$.check.dc})`).join(", ");j+=`
Dice Results: ${P}`}}else if(j=`

ACTION VALIDATION: Some aspects of this action are challenging for your character.`,y.actions){const $=y.actions.filter(S=>!S.check.isSuccess).map(S=>`${S.action}: Failure (Roll: ${S.check.roll}, DC: ${S.check.dc})`).join(", ");j+=`
Failed Actions: ${$}`}}else f.valid||(j=`

ACTION VALIDATION: ${f.response}`,f.suggestion&&(j+=`
Suggestion: ${f.suggestion}`))}const E=s.map(b=>({role:b.role,content:b.content}));let D="";l&&(D=`
Party Theme: ${l.description||"No theme provided"}`);let w="";a&&(w=`
STORY STATE CONTEXT:
Current Location: ${((r=a.currentLocation)==null?void 0:r.name)||"Unknown"} - ${((c=a.currentLocation)==null?void 0:c.description)||""}
Active NPCs: ${Object.keys(a.activeNPCs||{}).join(", ")||"None"}
Active Plot Threads: ${((m=a.activePlotThreads)==null?void 0:m.map(b=>`${b.title} (${Math.round(b.progress*100)}%)`).join(", "))||"None"}
Recent Events: ${((u=(p=a.worldState)==null?void 0:p.recentEvents)==null?void 0:u.slice(-3).map(b=>b.event).join(", "))||"None"}

CHARACTER RELATIONSHIPS:
${n.map(b=>{var S;const P=((S=a.characterArcs)==null?void 0:S[b.id])||{},$=Object.entries(P.relationships||{}).map(([Y,M])=>`${Y} (${M})`).join(", ");return`${b.name}: ${$||"No established relationships"}`}).join(`
`)}

NPC CONTEXT:
${Object.entries(a.activeNPCs||{}).map(([b,P])=>{var $;return`${b}: ${P.disposition} disposition, knowledge: ${(($=P.knowledge)==null?void 0:$.join(", "))||"none"}, goal: ${P.currentGoal||"unknown"}`}).join(`
`)}`);const v=`As a Dungeon Master, continue the story based on the player's response.

Party: ${d}${D}
Player Response: "${t}" (Type: ${o})
Response Type Context:
- individual: One character's personal action
- team: Group action or decision
- investigate: Looking for clues or information
- combat: Combat-related action
- social: Social interaction or diplomacy${w}

Previous Story Context:
${E.map(b=>`${b.role==="assistant"?"DM":"Player"}: ${b.content}`).join(`
`)}

CRITICAL CONSISTENCY REQUIREMENTS:
1. Maintain all established NPC relationships and dispositions from the story state
2. Keep current location details consistent with previous descriptions
3. Continue active plot threads naturally without contradictions
4. Reference previous discoveries and character development
5. Build upon established world state and recent events
6. Ensure character actions align with their established motivations and relationships
7. Maintain the established tone and atmosphere
8. Reference specific NPCs that the party has already met
9. Build upon existing plot threads rather than introducing new unrelated elements
10. Consider character relationships when determining NPC reactions

ACTION VALIDATION GUIDELINES:
- If the action validation shows the action is impossible, gently redirect the player while maintaining story flow
- If the action validation shows the action is challenging, incorporate the difficulty into the narrative
- If the action validation shows the action is successful, proceed with the action as described
- Always maintain story coherence and character consistency
- Use the validation results to inform how the action plays out in the story

Please provide a compelling continuation that:
1. Acknowledges the player's action in context of the current situation and location
2. References relevant NPCs and their established relationships with the party
3. Continues or advances active plot threads appropriately
4. Updates character relationships based on the action
5. Maintains location and atmosphere consistency
6. Ends with a clear situation that invites the next player to respond
7. Encourages character interaction and roleplay
8. Provides multiple possible directions for the party to explore
9. Builds upon the established story state and character development
10. Incorporates action validation results naturally into the narrative

Keep your response engaging but concise (2-3 paragraphs maximum). Remember that only one player responds at a time, so end with a situation that gives the next player something meaningful to react to.${j}`;return{content:(await T([{role:"system",content:this.systemPrompt},...E,{role:"user",content:v}],"gpt-4",800,.8)).choices[0].message.content,actionValidation:f,diceResult:y}}catch(d){throw console.error("Error generating story continuation:",d),new Error(`Failed to generate story continuation: ${d.message}`)}}async generatePlotOptions(n,s=null){try{const t=n.map(c=>`${c.name} - Level ${c.level} ${c.race} ${c.class}. ${c.personality||""}. ${c.backstory||""}`).join(`
`);let a="";s&&(a=`
Party Theme: ${s.description||"No theme provided"}`);const o="You are a Dungeon Master for D&D 5e. You MUST generate exactly 3 plot options, no more, no less. Follow the exact format provided. Do not use party names in the plots. Keep summaries brief (1-2 sentences maximum). DO NOT repeat plots or generate duplicates.",l=`Generate exactly 3 distinct campaign plot options for this party. 

REQUIRED FORMAT - Follow this exact structure:

Plot 1: [Title]
[Brief summary - 1-2 sentences maximum]

Plot 2: [Title]  
[Brief summary - 1-2 sentences maximum]

Plot 3: [Title]
[Brief summary - 1-2 sentences maximum]

Party: ${t}${a}

CRITICAL REQUIREMENTS:
- Generate EXACTLY 3 plots, no more, no less
- Use the party theme to influence the plot lines and atmosphere
- Do NOT use the party name in the plots - focus on the characters and theme
- Each summary must be 1-2 sentences maximum
- Follow the exact format above with "Plot 1:", "Plot 2:", "Plot 3:" labels
- Do not add any additional text, explanations, or formatting
- Do not repeat or duplicate any plots
- Stop after Plot 3 - do not generate more plots

Make each plot distinct and appealing to different play styles.`;return(await T([{role:"system",content:o},{role:"user",content:l}],"gpt-4",600,.8)).choices[0].message.content}catch(t){throw console.error("Error generating plot options:",t),new Error(`Failed to generate plot options: ${t.message}`)}}async generateStoryIntroduction(n,s,t,a=null){try{const o=n.map(m=>`${m.name} - Level ${m.level} ${m.race} ${m.class}. ${m.personality||""}. ${m.backstory||""}`).join(`
`);let l="";a&&(l=`
Party Theme: ${a.description||"No theme provided"}`);const r=`As a Dungeon Master, create an engaging story introduction for the beginning of this campaign.

Party: ${o}${l}
Selected Plot: ${s}
Plot Number: ${t}

IMPORTANT: Generate ONLY ONE story introduction for the selected plot above. Do NOT generate introductions for multiple plots or options.

Create an introduction that includes:
1. A vivid description of the starting town/settlement where the party begins
2. How each character arrives or is already present in this location
3. The initial situation or hook that draws the party together
4. A sense of atmosphere and setting that matches the chosen plot
5. An opening scene that gives the party their first decision or action to take

Important Guidelines:
- Use the party theme to influence the atmosphere and context
- Incorporate themes and elements from the party theme to create atmosphere and context
- Consider how the party's background and composition might influence the starting situation
- Focus on the characters and their individual stories
- The story should feel cohesive with the established theme
- Generate ONLY ONE introduction for the selected plot

Make this feel like the opening of an epic adventure. Set the tone, establish the setting, and give the party a clear starting point. End with a situation that requires the party to make a choice or take action.

Keep the introduction engaging but concise (3-4 paragraphs maximum).`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:r}],"gpt-4",800,.8)).choices[0].message.content}catch(o){throw console.error("Error generating story introduction:",o),new Error(`Failed to generate story introduction: ${o.message}`)}}async generateStructuredStoryResponse(n,s,t,a,o,l=null,r=null){var c,m,p;try{const u=n.map(w=>`${w.name} - Level ${w.level} ${w.race} ${w.class}`).join(", "),d=s.filter(w=>w&&typeof w=="object"&&w.role&&w.content).map(w=>({role:w.role,content:w.content}));let f="";r&&(f=`
Party Theme: ${r.description||"No theme provided"}`);const y=o.length>0?`
Discovered Objectives: ${o.map(w=>w.title).join(", ")}`:"";let j="";l&&(j=`
STORY STATE CONTEXT:
Current Location: ${((c=l.currentLocation)==null?void 0:c.name)||"Unknown"} - ${((m=l.currentLocation)==null?void 0:m.description)||""}
Active NPCs: ${Object.keys(l.activeNPCs||{}).join(", ")||"None"}
Active Plot Threads: ${((p=l.activePlotThreads)==null?void 0:p.map(w=>`${w.title} (${Math.round(w.progress*100)}%)`).join(", "))||"None"}
Character Relationships: ${Object.entries(l.characterArcs||{}).map(([w,v])=>{const k=n.find(b=>b.id===w);return`${k==null?void 0:k.name}: ${Object.entries(v.relationships||{}).map(([b,P])=>`${b} (${P})`).join(", ")||"No relationships"}`}).join("; ")}`);const E=`As a Dungeon Master, continue the story based on the player's response, considering the current story phase and discovered objectives.

Party: ${u}${f}
Current Phase: ${a}
Player Response: "${t}"${y}${j}

Story Phases:
- Investigation: Focus on discovery, clues, and gathering information
- Conflict: Focus on tension, threats, and potential combat
- Resolution: Focus on choices, consequences, and story conclusion

CRITICAL CONSISTENCY REQUIREMENTS:
1. Maintain all established NPC relationships and dispositions from the story state
2. Keep current location details consistent with previous descriptions
3. Continue active plot threads naturally without contradictions
4. Reference previous discoveries and character development
5. Build upon established world state and recent events
6. Ensure character actions align with their established motivations and relationships
7. Maintain the established tone and atmosphere
8. Reference specific NPCs that the party has already met
9. Build upon existing plot threads rather than introducing new unrelated elements
10. Consider character relationships when determining NPC reactions

ENEMY INFORMATION REQUIREMENTS (when in Conflict phase):
If the story involves combat or enemies, provide detailed enemy information in the following format:

**ENEMY_DETAILS:**
[For each enemy present, provide:]
Name: [Enemy name if humanoid, or descriptive name like "Alpha Wolf"]
Type: [Enemy type: humanoid, beast, undead, etc.]
Level: [Enemy level relative to party]
HP: [Hit points]
AC: [Armor class]
Basic Attack: [Description of basic attack and damage]
Special Ability: [Description of special ability or attack]
Stats: [Brief description of key stats like "Strong and aggressive" or "Quick and stealthy"]

IMPORTANT: You MUST format your response EXACTLY as follows:

**STORY_CONTENT:**
[Your main story continuation here - 2-3 paragraphs that acknowledge the player's action, continue the plot, and set up the next situation]

**CURRENT_LOCATION:**
[Updated location description or "No change" if location remains the same]

**ACTIVE_NPCS:**
[List of NPCs currently present or relevant to the scene, separated by commas]

**PLOT_DEVELOPMENTS:**
[Key plot developments or revelations from this response]

**CHARACTER_REACTIONS:**
[How NPCs react to the player's action, if applicable]

**NEXT_ACTIONS:**
[2-3 clear options or directions the party can take next]

**STORY_TONE:**
[The current mood/atmosphere: tense, mysterious, hopeful, dangerous, etc.]

**PHASE_STATUS:**
[Current story phase: investigation, conflict, or resolution]

**ENEMY_DETAILS:** (only include if enemies are present)
[Detailed enemy information as specified above]

Keep your response engaging but concise. Remember that only one player responds at a time, so end with a situation that gives the next player something meaningful to react to.`;return(await T([{role:"system",content:this.systemPrompt},...d,{role:"user",content:E}],"gpt-4",1e3,.8)).choices[0].message.content}catch(u){throw console.error("Error generating structured story response:",u),new Error(`Failed to generate structured story response: ${u.message}`)}}async generatePhaseTransition(n,s,t,a=null){try{const o=n.map(m=>`${m.name} - Level ${m.level} ${m.race} ${m.class}`).join(", ");let l="";a&&(l=`
Party Theme: ${a.description||"No theme provided"}`);const r=`As a Dungeon Master, create a phase transition message for the story.

Party: ${o}${l}
Current Phase: ${s}
Story Progress: ${t}

Create a transition that:
1. Acknowledges the progress made so far
2. Signals the shift to the new phase
3. Sets up the new challenges and opportunities
4. Maintains the established tone and atmosphere
5. Gives the party clear direction for the next phase

Make this feel like a natural progression in the story.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:r}],"gpt-4",600,.7)).choices[0].message.content}catch(o){throw console.error("Error generating phase transition:",o),new Error(`Failed to generate phase transition: ${o.message}`)}}async generateObjectiveCompletion(n,s,t,a=null){try{const o=n.map(m=>`${m.name} - Level ${m.level} ${m.race} ${m.class}`).join(", ");let l="";a&&(l=`
Party Theme: ${a.description||"No theme provided"}`);const r=`As a Dungeon Master, create a completion message for an objective.

Party: ${o}${l}
Completed Objective: ${s.title}
Story Context: ${t}

Create a completion message that:
1. Celebrates the achievement
2. Provides closure for this objective
3. Sets up the next challenge or objective
4. Maintains story momentum
5. Acknowledges the party's efforts

Make this feel rewarding and meaningful.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:r}],"gpt-4",600,.7)).choices[0].message.content}catch(o){throw console.error("Error generating objective completion:",o),new Error(`Failed to generate objective completion: ${o.message}`)}}async generateCampaignContinuation(n,s,t,a,o=null){try{const l=n.map(u=>`${u.name} - Level ${u.level} ${u.race} ${u.class}`).join(", "),r=t.filter(u=>u&&typeof u=="object"&&u.role&&u.content).map(u=>({role:u.role,content:u.content}));let c="";o&&(c=`
Party Theme: ${o.description||"No theme provided"}`);const m=`As a Dungeon Master, continue the ongoing campaign story.

Party: ${l}${c}
Campaign Goal: ${s.mainGoal||"No specific goal"}
Campaign Progress: ${s.campaignProgress||"Beginning"}
Player Response: "${a}"

Previous Story Context:
${r.map(u=>`${u.role==="assistant"?"DM":"Player"}: ${u.content}`).join(`
`)}

Continue the story while:
1. Building toward the main campaign goal
2. Maintaining consistency with previous events
3. Developing character relationships and arcs
4. Creating meaningful choices and consequences
5. Advancing the overall plot

Keep your response engaging but concise (2-3 paragraphs maximum).`;return(await T([{role:"system",content:this.systemPrompt},...r,{role:"user",content:m}],"gpt-4",800,.8)).choices[0].message.content}catch(l){throw console.error("Error generating campaign continuation:",l),new Error(`Failed to generate campaign continuation: ${l.message}`)}}async generateCampaignGoal(n,s,t=null){try{const a=n.map(c=>`${c.name} - Level ${c.level} ${c.race} ${c.class}`).join(", ");let o="";t&&(o=`
Party Theme: ${t.description||"No theme provided"}`);const l=`As a Dungeon Master, create a clear campaign goal based on the selected plot.

Party: ${a}${o}
Selected Plot: ${s}

IMPORTANT: Generate ONLY ONE campaign goal for the selected plot above. Do NOT generate multiple goals or options.

Create a campaign goal that:
1. Is clear and achievable
2. Provides direction for the entire campaign
3. Involves all party members
4. Has multiple possible paths to completion
5. Creates meaningful stakes and consequences
6. Is specific to the selected plot only

Make this goal compelling and motivating for the party. Generate ONLY ONE goal.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:l}],"gpt-4",600,.7)).choices[0].message.content}catch(a){throw console.error("Error generating campaign goal:",a),new Error(`Failed to generate campaign goal: ${a.message}`)}}async generateSessionSummary(n,s,t,a,o=null){try{const l=a.map(p=>`${p.name} - Level ${p.level} ${p.race} ${p.class}`).join(", ");let r="";o&&(r=`
Party Theme: ${o.description||"No theme provided"}`);const c=`As a Dungeon Master, create a session summary for this campaign session.

Party: ${l}${r}
Campaign Goal: ${n.mainGoal||"No specific goal"}
Objectives: ${t.map(p=>p.title).join(", ")}
Story Messages: ${s.length} total messages

Create a summary that:
1. Recaps the major events of the session
2. Highlights character development and relationships
3. Notes progress toward objectives
4. Sets up expectations for the next session
5. Maintains the established tone and atmosphere

Make this summary engaging and informative.`;return(await T([{role:"system",content:this.systemPrompt},{role:"user",content:c}],"gpt-4",800,.7)).choices[0].message.content}catch(l){throw console.error("Error generating session summary:",l),new Error(`Failed to generate session summary: ${l.message}`)}}}const de=new Je;function et(i,n,s){const[t,a]=x.useState(null),[o,l]=x.useState(null),[r,c]=x.useState([]),[m,p]=x.useState([]),[u,d]=x.useState(!0),[f,y]=x.useState(""),[j,E]=x.useState(""),[D,w]=x.useState("storytelling"),[v,k]=x.useState([]),[b,P]=x.useState(null),[$,S]=x.useState(!1),[Y,M]=x.useState(null),[_,X]=x.useState(!1),[Q,he]=x.useState(null),[V,ue]=x.useState(null),[J,ee]=x.useState(!1),[te,U]=x.useState(!1),[se,G]=x.useState(!1),[ne,ae]=x.useState(!1),[ie,W]=x.useState([]),[oe,Z]=x.useState(!1),[F,R]=x.useState(!1),[re,O]=x.useState(!1),we=()=>{var h;return((h=t==null?void 0:t.readyPlayers)==null?void 0:h.length)||0},Ne=()=>r.length,je=()=>m.sort((h,g)=>h.name.localeCompare(g.name)),Ce=h=>h?h.replace(/\*\*(.*?)\*\*/g,'<strong class="text-yellow-400 font-bold">$1</strong>').replace(/\*(.*?)\*/g,'<em class="text-blue-400 italic">$1</em>').replace(/`(.*?)`/g,'<code class="bg-slate-700 px-2 py-1 rounded text-slate-200 font-mono text-sm">$1</code>').replace(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*):/g,'<span class="text-green-400 font-semibold">$1:</span>').replace(/\b(weapon|sword|shield|armor|magic|spell|dragon|monster|treasure|gold|silver|quest|adventure|hero|villain)\b/gi,'<span class="text-orange-400 font-medium">$1</span>').replace(/\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/g,g=>g.includes("<")||["The","A","An","And","Or","But","In","On","At","To","For","Of","With","By"].includes(g)?g:`<span class="text-purple-400 font-medium">${g}</span>`).replace(/\n/g,"<br>"):"";x.useEffect(()=>{i&&n&&ge()},[i,n]),x.useEffect(()=>{if(t!=null&&t.id){const h=Fe(t.id,async g=>{var N,C,A,I,H,pe;if(g){a(g),g.deadPlayers&&g.deadPlayers.length>0&&(W(g.deadPlayers),Z(!0));const K=g.currentContent||"",ct=(g.storyMetadata||{}).phaseStatus||(K.toLowerCase().includes("phase_status:")?(C=(N=K.toLowerCase().split("phase_status:")[1])==null?void 0:N.split(`
`)[0])==null?void 0:C.trim():null)||(K.toLowerCase().includes("conflict")?"conflict":null),mt=["attack","battle","combat","fight","enemy","enemies","monster","creature","ghoul","bandit","goblin","troll"].some(q=>K.toLowerCase().includes(q));if(g.storyMetadata&&String(g.storyMetadata.phaseStatus).toLowerCase()==="conflict"&&!re&&!F){R(!0);const q=(o==null?void 0:o.members)||[];if(((A=g.readyPlayers)==null?void 0:A.length)===q.length&&q.length>0){if(!(m.length===q.length))return;try{const ce=Le(((I=g.storyMetadata)==null?void 0:I.enemyDetails)||[]),Oe=await me.createCombatSession(i,m.length>0?m:r,ce,g.currentContent||"Combat encounter");R(!1),O(!0),s(`/combat/${Oe.id}`)}catch(ce){console.error("❌ Failed to create combat session:",ce),R(!1),O(!1)}setTimeout(()=>{F&&(R(!1),O(!1))},5e3)}}else g.storyMetadata&&String(g.storyMetadata.phaseStatus).toLowerCase()!=="conflict"&&(O(!1),R(!1));(H=g.readyPlayers)!=null&&H.includes(n==null?void 0:n.uid)&&ee(!0);const fe=(o==null?void 0:o.members)||[];((pe=g.readyPlayers)==null?void 0:pe.length)===fe.length&&fe.length>0?U(!0):U(!1)}});return ue(()=>h),()=>h()}},[t==null?void 0:t.id,n==null?void 0:n.uid,o==null?void 0:o.members,m,s,re]),x.useEffect(()=>{if(i){const h=He(i,async g=>{if(g){l(g),c(g.members||[]);try{const N=await be(i);p(N)}catch(N){console.error("❌ Error reloading characters:",N)}}});return()=>h()}},[i]),x.useEffect(()=>()=>{V&&V()},[V]);const ge=x.useCallback(async()=>{if(i)try{d(!0);const h=await Ue(i);l(h);const g=(h==null?void 0:h.members)||[];c(g);let N;console.log("useCampaignStory: Loading story data for campaign type:",h==null?void 0:h.campaignType),(h==null?void 0:h.campaignType)==="manual"?(console.log("useCampaignStory: Using manual campaign service"),N=await ze.loadCampaignData(i),console.log("useCampaignStory: Manual campaign story data:",N)):(console.log("useCampaignStory: Using AI campaign service"),N=await Be(i),N||(N=await Ye(i)),console.log("useCampaignStory: AI campaign story data:",N)),a(N);const C=await be(i);p(C);const A=Ke((h==null?void 0:h.description)||"adventure");k(A)}catch(h){console.error("❌ Error loading story and characters:",h),y("Failed to load campaign data")}finally{d(!1)}},[i]),ke=x.useCallback(async()=>{if(!(!n||!t))try{d(!0),await Ge(t.id,n.uid)}catch(h){console.error("❌ Error readying up:",h),y("Failed to ready up")}finally{d(!1)}},[n,t]),Se=x.useCallback(async()=>{if(!(!n||!t))try{d(!0),G(!0),await L(t.id,{status:"generating"});try{const h=await de.generateStoryPlots(m,(o==null?void 0:o.description)||"An epic adventure awaits!",v),g=De(h);await L(t.id,{status:"voting",availablePlots:g})}catch(h){console.warn("AI service unavailable, using fallback plots:",h);const g=[{title:"The Lost Artifact",description:"A powerful artifact has been stolen and the party must track it down through dangerous territory.",summary:"An ancient artifact of great power has been stolen from the local temple. The party must follow the trail of the thieves through dangerous wilderness and hostile territory.",campaignLength:"medium"},{title:"The Dark Forest",description:"A mysterious forest has appeared overnight, and strange creatures are emerging from its depths.",summary:"A dark forest has mysteriously appeared on the outskirts of town. Strange creatures and magical phenomena are emerging, and the party must investigate the source.",campaignLength:"short"},{title:"The Dragon's Lair",description:"A dragon has been terrorizing the countryside, and the party must find a way to stop it.",summary:"A fearsome dragon has been attacking villages and stealing livestock. The party must find the dragon's lair and either defeat it or negotiate a peaceful solution.",campaignLength:"long"}];await L(t.id,{status:"voting",availablePlots:g}),y("AI service temporarily unavailable. Using predefined plot options.")}}catch(h){console.error("❌ Error starting story:",h),y("Failed to start story generation"),await L(t.id,{status:"ready_up"})}finally{d(!1),G(!1)}},[n,t,m,o==null?void 0:o.description,v]),Pe=x.useCallback(async h=>{var g;try{d(!0);const C=(((g=t==null?void 0:t.availablePlots)==null?void 0:g.filter(A=>A.title&&!A.title.startsWith("Plot ")))||[])[h];if(!C){y("Selected plot not found");return}await L(t.id,{status:"generating_story",selectedPlot:h,selectedPlotData:C,currentContent:`Generating story content for: ${C.title}...`});try{const A=await de.generateStoryIntroduction(m,C.description,C.title,o);await L(t.id,{status:"storytelling",currentContent:A||`The adventure begins with ${C.title}!`,currentSpeaker:{userId:o.dmId,name:"Dungeon Master",id:"dm",race:"DM",class:"Dungeon Master"}})}catch(A){console.warn("AI service unavailable, using fallback story:",A);const I=`The adventure begins with ${C.title}!

${C.summary}

The party finds themselves at the beginning of this epic journey. The path ahead is uncertain, but the promise of adventure and glory awaits those brave enough to take the first step.

What would you like to do?`;await L(t.id,{status:"storytelling",currentContent:I,currentSpeaker:{userId:o.dmId,name:"Dungeon Master",id:"dm",race:"DM",class:"Dungeon Master"}}),y("AI service temporarily unavailable. Using simplified story introduction.")}}catch(N){console.error("❌ Error selecting plot:",N),y("Failed to select plot"),await L(t.id,{status:"voting"})}finally{d(!1)}},[t,m,o]),le=x.useCallback(async()=>{if(j.trim())try{d(!0),y("");const h=m.find(g=>g.userId===(n==null?void 0:n.uid));if(!h){y("You need a character to participate in the story");return}try{const g=await Xe.validateAction(j,h,(t==null?void 0:t.currentContent)||"",m);if(g.isValid===!1){M(g),S(!0);return}}catch(g){console.warn("Action validation service unavailable, proceeding without validation:",g)}await qe(t.id,{content:j,speaker:h.name,timestamp:new Date,userId:n.uid});try{const g=await de.generateStoryResponse(m,(t==null?void 0:t.currentContent)||"",j,h,o);await L(t.id,{currentContent:g,currentSpeaker:{userId:o.dmId,name:"Dungeon Master",id:"dm",race:"DM",class:"Dungeon Master"}})}catch(g){console.warn("AI service unavailable, using fallback response:",g);const N=`The Dungeon Master acknowledges your action: "${j}"

The story continues as the party moves forward with their adventure.`;await L(t.id,{currentContent:N,currentSpeaker:{userId:o.dmId,name:"Dungeon Master",id:"dm",race:"DM",class:"Dungeon Master"}}),y("AI service temporarily unavailable. Using simplified response.")}E("")}catch(h){console.error("❌ Error sending response:",h),y("Failed to send response")}finally{d(!1)}},[j,n,t,m,o]),$e=x.useCallback(async h=>{if(t)try{await _e(t.id,{userId:h.userId,name:h.name,id:h.id,race:h.race,class:h.class})}catch(g){console.error("❌ Error setting speaker:",g),y("Failed to set speaker")}},[t]),Ae=x.useCallback(()=>{S(!1),M(null)},[]),Te=x.useCallback(async()=>{S(!1),M(null),await le()},[le]),Ee=x.useCallback(()=>{S(!1),M(null)},[]),Re=x.useCallback(async()=>{O(!0),R(!0);try{const h=await me.createCombatSession(i,m.length>0?m:r,[],(t==null?void 0:t.currentContent)||"Manual combat encounter");R(!1),O(!0),s(`/combat/${h.id}`)}catch(h){console.error("❌ Failed to create manual combat session:",h),R(!1),O(!1)}},[i,m,r,t,s]),Ie=x.useCallback(()=>{O(!1),R(!1)},[]),De=h=>{try{if(h.trim().startsWith("{")||h.trim().startsWith("["))return JSON.parse(h);const g=[];return h.split(/\d+\.\s+/).filter(C=>C.trim()).forEach(C=>{const A=C.trim().split(`
`).filter(I=>I.trim());if(A.length>=2){const I=A[0].trim(),H=A[1].trim();g.push({title:I,description:H,campaignLength:"medium"})}}),g.length>0?g:null}catch(g){return console.error("Error parsing plots:",g),null}},Le=h=>Array.isArray(h)?h.map((g,N)=>{const C=Me(g.stats||"",g.type||"Unknown");return{id:`enemy_${N}`,name:g.name||`${g.type||"Enemy"} ${N+1}`,type:g.type||"Unknown",hp:C.hp||10,maxHp:C.hp||10,ac:C.ac||10,attackBonus:C.attackBonus||3,damage:C.damage||"1d6",description:g.description||"A mysterious enemy"}}):[],Me=(h,g)=>{const N={hp:10,ac:10,attackBonus:3,damage:"1d6"},C=h.match(/HP[:\s]*(\d+)/i);C&&(N.hp=parseInt(C[1]));const A=h.match(/AC[:\s]*(\d+)/i);A&&(N.ac=parseInt(A[1]));const I=h.match(/Attack[:\s]*\+?(\d+)/i);I&&(N.attackBonus=parseInt(I[1]));const H=h.match(/Damage[:\s]*(\d+d\d+)/i);return H&&(N.damage=H[1]),N};return{story:t,party:o,partyMembers:r,partyCharacters:m,loading:u,error:f,playerResponse:j,currentPhase:D,objectives:v,inlineValidation:b,showActionValidation:$,actionValidation:Y,showDiceRoll:_,diceResult:Q,isReady:J,allPlayersReady:te,isGeneratingPlots:se,showDebug:ne,deadPlayers:ie,showDeathRecap:oe,combatLoading:F,hasNavigatedToCombat:re,setStory:a,setParty:l,setPartyMembers:c,setPartyCharacters:p,setLoading:d,setError:y,setPlayerResponse:E,setCurrentPhase:w,setObjectives:k,setInlineValidation:P,setShowActionValidation:S,setActionValidation:M,setShowDiceRoll:X,setDiceResult:he,setIsReady:ee,setAllPlayersReady:U,setIsGeneratingPlots:G,setShowDebug:ae,setDeadPlayers:W,setShowDeathRecap:Z,setCombatLoading:R,setHasNavigatedToCombat:O,getReadyCount:we,getTotalPlayers:Ne,getSortedCharacters:je,highlightKeywords:Ce,loadStoryAndCharacters:ge,handleReadyUp:ke,handleStartStory:Se,handlePlotSelection:Pe,handleSendResponse:le,handleSetSpeaker:$e,handleActionValidationClose:Ae,handleActionProceed:Te,handleActionRevise:Ee,handleManualCombatTrigger:Re,handleResetCombatState:Ie}}function tt({validation:i,onClose:n,onProceed:s,onRevise:t}){const[a,o]=x.useState(!1),[l,r]=x.useState(!1),[c,m]=x.useState(null);if(x.useEffect(()=>{if(i!=null&&i.diceResult){o(!0),r(!0);const d=setTimeout(()=>{r(!1),m(i.diceResult)},2e3);return()=>clearTimeout(d)}},[i]),!i)return null;const p=(d,f)=>f==="critical success"?"text-green-800 bg-green-200 border-green-400":f==="great success"?"text-green-700 bg-green-100 border-green-300":f==="success"?"text-green-600 bg-green-50 border-green-200":f==="failure"?"text-red-600 bg-red-50 border-red-200":f==="great failure"?"text-red-700 bg-red-100 border-red-300":f==="critical failure"?"text-red-800 bg-red-200 border-red-400":d?"text-green-600 bg-green-100 border-green-300":"text-red-600 bg-red-100 border-red-300",u=()=>i.diceResult?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-amber-900 to-amber-800 rounded-2xl p-8 max-w-2xl w-full mx-4 border-4 border-amber-600 shadow-2xl",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"text-amber-200 text-lg font-bold mb-2",children:"🎲 THE DICE HAVE BEEN CAST 🎲"}),e.jsx("div",{className:"text-amber-300 text-sm",children:"The fate of your party hangs in the balance..."})]}),e.jsxs("div",{className:"bg-amber-950/50 rounded-lg p-4 mb-6 border border-amber-500",children:[e.jsx("div",{className:"text-amber-200 font-bold text-lg mb-2",children:"Your Action"}),e.jsx("div",{className:"text-amber-100 text-sm",children:i.diceResult.actions?i.diceResult.actions.map((d,f)=>e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold capitalize",children:d.action}),e.jsxs("span",{className:"text-amber-300",children:[": ",d.description]})]},f)).join(""):"Rolling the dice..."})]}),l?e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"text-6xl mb-4 animate-bounce",children:"🎲"}),e.jsx("div",{className:"text-amber-200 text-xl font-bold mb-2",children:"Rolling..."}),e.jsx("div",{className:"text-amber-300 text-sm",children:"The dice tumble across the table"})]}):e.jsxs("div",{className:"space-y-4",children:[i.diceResult.actions?i.diceResult.actions.map((d,f)=>e.jsxs("div",{className:`rounded-lg p-4 border-2 ${p(d.check.isSuccess,d.check.degree)}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"text-lg font-bold capitalize",children:d.action}),e.jsx("div",{className:"text-2xl font-bold",children:d.check.degree?d.check.degree.replace("_"," ").toUpperCase():d.check.isSuccess?"SUCCESS":"FAILURE"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center mb-3",children:[e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"ROLL"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:d.check.roll})]}),e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"TOTAL"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:d.check.totalRoll})]}),e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"DC"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:d.check.dc})]})]}),e.jsx("div",{className:"text-sm text-amber-200",children:d.description})]},f)):e.jsxs("div",{className:`rounded-lg p-6 border-2 text-center ${p(i.diceResult.isSuccess)}`,children:[e.jsx("div",{className:"text-2xl font-bold mb-4",children:i.diceResult.isSuccess?"SUCCESS!":"FAILURE!"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"ROLL"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:i.diceResult.roll})]}),e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"TOTAL"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:i.diceResult.totalRoll})]}),e.jsxs("div",{className:"bg-black/30 rounded p-2",children:[e.jsx("div",{className:"text-xs text-amber-300",children:"DC"}),e.jsx("div",{className:"text-xl font-mono font-bold text-amber-200",children:i.diceResult.dc})]})]})]}),i.diceResult.overallSuccess!==void 0&&e.jsxs("div",{className:`rounded-lg p-4 border-2 text-center ${i.diceResult.overallSuccess?"border-green-400 bg-green-900/50":"border-red-400 bg-red-900/50"}`,children:[e.jsx("div",{className:"text-xl font-bold mb-2",children:i.diceResult.overallSuccess?"🎉 MISSION ACCOMPLISHED! 🎉":"💀 THE DICE HAVE SPOKEN... 💀"}),e.jsx("div",{className:"text-sm",children:i.diceResult.overallSuccess?"Your party's combined efforts have succeeded!":"The challenge has proven too great this time..."})]})]}),!l&&e.jsxs("div",{className:"bg-amber-950/50 rounded-lg p-4 mt-6 border border-amber-500",children:[e.jsx("div",{className:"text-amber-200 font-bold mb-2",children:"🎭 Dungeon Master's Commentary"}),e.jsx("div",{className:"text-amber-100 text-sm italic",children:typeof i.response=="string"?i.response:i.response.story})]}),!l&&e.jsxs("div",{className:"mt-6 flex justify-center space-x-4",children:[i.type==="valid"?e.jsx("button",{onClick:s,className:"fantasy-button bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition-all",children:"🚀 PROCEED WITH FATE"}):e.jsx("button",{onClick:t,className:"fantasy-button bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition-all",children:"🔄 TRY AGAIN"}),e.jsx("button",{onClick:n,className:"fantasy-button bg-stone-600 hover:bg-stone-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition-all",children:"❌ CANCEL"})]})]})}):null;return a?u():e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-stone-800 to-stone-900 rounded-lg p-6 max-w-2xl w-full mx-4 border-2 border-stone-600 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-stone-200",children:"🎭 Action Validation"}),e.jsx("button",{onClick:n,className:"text-stone-400 hover:text-stone-200 text-xl",children:"✕"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-stone-700 rounded-lg border border-stone-600",children:[e.jsx("h4",{className:"font-semibold text-stone-200 mb-2",children:"🎭 Dungeon Master's Response"}),e.jsx("div",{className:"text-stone-300 italic leading-relaxed",children:typeof i.response=="string"?i.response:i.response.story})]}),i.suggestion&&e.jsxs("div",{className:"p-4 bg-blue-900/50 rounded-lg border border-blue-600",children:[e.jsx("h4",{className:"font-semibold text-blue-200 mb-2",children:"💡 Suggestion"}),e.jsx("p",{className:"text-blue-100",children:i.suggestion})]}),i.type!=="valid"&&e.jsxs("div",{className:"p-4 bg-purple-900/50 rounded-lg border border-purple-600",children:[e.jsx("h4",{className:"font-semibold text-purple-200 mb-2",children:"🔄 Alternative Approaches"}),e.jsxs("ul",{className:"text-purple-100 text-sm space-y-1",children:[e.jsx("li",{children:"• Try a more focused, single action"}),e.jsx("li",{children:"• Consider your character's abilities and limitations"}),e.jsx("li",{children:"• Think about what would be realistic in this situation"}),e.jsx("li",{children:"• Ask for clarification about what you're trying to achieve"})]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[i.type==="valid"?e.jsx("button",{onClick:s,className:"fantasy-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold",children:"Proceed with Action"}):e.jsx("button",{onClick:t,className:"fantasy-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold",children:"Revise Action"}),e.jsx("button",{onClick:n,className:"fantasy-button bg-stone-600 hover:bg-stone-700 text-white px-4 py-2 rounded font-bold",children:"Cancel"})]})]})})}function st({diceResult:i,onClose:n}){if(!i)return null;const s=a=>{switch(a){case"critical success":return"text-green-600 bg-green-100";case"great success":return"text-green-700 bg-green-50";case"success":return"text-blue-600 bg-blue-100";case"failure":return"text-yellow-600 bg-yellow-100";case"great failure":return"text-orange-600 bg-orange-100";case"critical failure":return"text-red-600 bg-red-100";default:return"text-gray-600 bg-gray-100"}},t=a=>{switch(a){case"critical success":return"🎯";case"great success":return"✅";case"success":return"✓";case"failure":return"⚠️";case"great failure":return"❌";case"critical failure":return"💥";default:return"🎲"}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-stone-800",children:"Dice Roll Results"}),e.jsx("button",{onClick:n,className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),i.actions?e.jsxs("div",{className:"space-y-4",children:[i.actions.map((a,o)=>e.jsxs("div",{className:"border border-stone-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-stone-700 capitalize",children:a.action}),e.jsxs("span",{className:`px-2 py-1 rounded text-sm font-medium ${s(a.check.degree)}`,children:[t(a.check.degree)," ",a.check.degree]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Roll:"}),e.jsx("span",{className:"font-mono ml-1",children:a.check.roll})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Total:"}),e.jsx("span",{className:"font-mono ml-1",children:a.check.totalRoll})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"DC:"}),e.jsx("span",{className:"font-mono ml-1",children:a.check.dc})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Margin:"}),e.jsxs("span",{className:`font-mono ml-1 ${a.check.margin>=0?"text-green-600":"text-red-600"}`,children:[a.check.margin>=0?"+":"",a.check.margin]})]})]}),a.check.circumstanceBonus!==0&&e.jsxs("div",{className:"mt-2 text-xs text-stone-500",children:["Circumstance bonus: ",a.check.circumstanceBonus>=0?"+":"",a.check.circumstanceBonus]})]},o)),e.jsxs("div",{className:"mt-4 p-3 bg-stone-50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-stone-700 mb-2",children:"Overall Result"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 rounded text-sm font-medium ${i.overallSuccess?"text-green-600 bg-green-100":"text-red-600 bg-red-100"}`,children:i.overallSuccess?"✅ Success":"❌ Partial Failure"}),i.hasCriticalFailures&&e.jsx("span",{className:"text-red-600 text-sm",children:"⚠️ Critical failures occurred"})]})]})]}):e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"border border-stone-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-stone-700 capitalize",children:i.actionType}),e.jsxs("span",{className:`px-2 py-1 rounded text-sm font-medium ${s(i.degree)}`,children:[t(i.degree)," ",i.degree]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Roll:"}),e.jsx("span",{className:"font-mono ml-1",children:i.roll})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Total:"}),e.jsx("span",{className:"font-mono ml-1",children:i.totalRoll})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"DC:"}),e.jsx("span",{className:"font-mono ml-1",children:i.dc})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-stone-600",children:"Margin:"}),e.jsxs("span",{className:`font-mono ml-1 ${i.margin>=0?"text-green-600":"text-red-600"}`,children:[i.margin>=0?"+":"",i.margin]})]})]}),e.jsxs("div",{className:"mt-2 text-xs text-stone-500",children:[e.jsxs("div",{children:["Primary Mod: ",i.primaryMod>=0?"+":"",i.primaryMod]}),e.jsxs("div",{children:["Proficiency: ",i.proficiencyMod>=0?"+":"",i.proficiencyMod]}),i.circumstanceBonus!==0&&e.jsxs("div",{children:["Circumstance: ",i.circumstanceBonus>=0?"+":"",i.circumstanceBonus]})]})]})}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{onClick:n,className:"fantasy-button bg-stone-600 hover:bg-stone-700",children:"Close"})})]})})}function nt({story:i,party:n,user:s,partyCharacters:t,partyMembers:a,isReady:o,allPlayersReady:l,loading:r,isGeneratingPlots:c,onReadyUp:m,onStartStory:p,navigate:u,partyId:d}){const f=()=>{var j;return((j=i==null?void 0:i.readyPlayers)==null?void 0:j.length)||0},y=()=>a.length;return e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-8 max-w-4xl mx-auto mb-6",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-200 mb-3",children:"Campaign Lobby"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"Waiting for all players to ready up"}),e.jsxs("div",{className:"mt-8 mb-8",children:[e.jsxs("div",{className:"flex justify-center items-center space-x-4 mb-4",children:[e.jsxs("div",{className:"text-2xl font-semibold text-slate-300",children:[f(),"/",y()," Players Ready"]}),e.jsxs("div",{className:"text-lg text-slate-400",children:["(",Math.round(f()/y()*100),"%)"]})]}),e.jsx("div",{className:"w-full bg-slate-700 rounded-full h-4 max-w-lg mx-auto",children:e.jsx("div",{className:"bg-gradient-to-r from-green-500 to-green-400 h-4 rounded-full transition-all duration-500",style:{width:`${f()/y()*100}%`}})})]})]}),e.jsxs("div",{className:"text-center",children:[o?e.jsx("div",{className:"text-green-400 font-semibold text-xl bg-green-900/30 px-6 py-3 rounded-xl",children:"You are ready!"}):e.jsx("div",{className:"space-y-4",children:t.find(j=>j.userId===(s==null?void 0:s.uid))?e.jsx("button",{onClick:m,className:"bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white px-10 py-4 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg",children:"Ready Up"}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-300",children:"You need to create a character first"}),e.jsx("button",{onClick:()=>u(`/character-creation/${d}`),className:"bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white px-10 py-4 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 shadow-lg",children:"Create Character"})]})}),l&&(n==null?void 0:n.dmId)===(s==null?void 0:s.uid)&&e.jsx("div",{className:"mt-6",children:e.jsx("button",{onClick:p,disabled:r||c,className:"bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white px-10 py-4 rounded-xl font-semibold text-lg transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed",children:r||c?"Generating Story...":"Start Story Generation"})}),l&&(n==null?void 0:n.dmId)!==(s==null?void 0:s.uid)&&e.jsx("div",{className:"mt-6",children:e.jsx("div",{className:"text-blue-400 font-semibold text-lg bg-blue-900/30 px-6 py-3 rounded-xl",children:"Waiting for Dungeon Master to start the story..."})})]})]})}function at({story:i,party:n,user:s,loading:t,showDebug:a,setShowDebug:o,onPlotSelection:l,onStartStory:r}){var c,m;return e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-8 max-w-4xl mx-auto mb-6",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-200 mb-6 text-center",children:"Choose Your Adventure"}),e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx("button",{onClick:()=>o(!a),className:"bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded-lg text-sm transition-colors",children:a?"Hide Debug":"Show Debug"})}),a&&e.jsxs("div",{className:"mb-4 p-4 bg-slate-700/50 rounded-lg",children:[e.jsxs("p",{className:"text-slate-300 text-sm",children:["Debug: Available plots count: ",((c=i==null?void 0:i.availablePlots)==null?void 0:c.length)||0]}),e.jsxs("p",{className:"text-slate-300 text-sm",children:["Debug: Raw plots: ",JSON.stringify((m=i==null?void 0:i.availablePlots)==null?void 0:m.slice(0,2))]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:Array.isArray(i==null?void 0:i.availablePlots)&&i.availablePlots.length>0?i.availablePlots.map((p,u)=>e.jsxs("div",{className:"bg-slate-800/70 border-2 border-slate-600 rounded-xl p-6 hover:border-slate-500 transition-all duration-300",children:[e.jsx("h3",{className:"font-bold text-slate-200 text-xl mb-3",children:p.title}),e.jsx("p",{className:"text-slate-300 mb-4",children:p.description||"Adventure description here..."}),p.campaignLength&&e.jsxs("div",{className:"mb-4",children:[e.jsx("span",{className:"text-slate-400 text-sm",children:"Length: "}),e.jsx("span",{className:"text-slate-200 font-semibold capitalize",children:p.campaignLength})]}),(n==null?void 0:n.dmId)===(s==null?void 0:s.uid)?e.jsx("button",{onClick:()=>l(u),disabled:t,className:"w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed",children:t?"Selecting...":"Choose This Plot"}):e.jsx("div",{className:"text-center py-3",children:e.jsx("span",{className:"text-slate-400 text-sm",children:"Waiting for DM to choose..."})})]},u)):e.jsxs("div",{className:"col-span-3 text-center",children:[e.jsx("p",{className:"text-slate-300",children:"No plots available. Please try generating the story again."}),(n==null?void 0:n.dmId)===(s==null?void 0:s.uid)&&e.jsx("button",{onClick:r,className:"mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors",children:"Regenerate Plots"})]})}),(n==null?void 0:n.dmId)!==(s==null?void 0:s.uid)&&e.jsx("div",{className:"text-center mt-6",children:e.jsx("p",{className:"text-slate-300 text-lg",children:"Waiting for the Dungeon Master to select a plot..."})})]})}function it({story:i,party:n,user:s,partyCharacters:t,showDebug:a,setShowDebug:o,playerResponse:l,setPlayerResponse:r,loading:c,onSendResponse:m,onSetSpeaker:p,highlightKeywords:u}){var f,y,j,E,D,w;const d=()=>t.sort((v,k)=>v.name.localeCompare(k.name));return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"flex flex-col gap-y-6 lg:sticky lg:top-6",children:[e.jsxs("div",{className:"hidden lg:block bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{className:"font-bold text-slate-200",children:"Party Members"}),e.jsx("button",{onClick:()=>o(!a),className:"text-xs bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded text-slate-200",children:a?"Hide Debug":"Show Debug"})]}),a&&e.jsxs("div",{className:"mb-2 p-2 bg-slate-700/50 rounded text-xs",children:[e.jsxs("p",{className:"text-slate-300",children:["Debug: Characters loaded: ",t.length]}),e.jsxs("p",{className:"text-slate-300",children:["Debug: Current Speaker: ",JSON.stringify(i==null?void 0:i.currentSpeaker)]}),e.jsxs("p",{className:"text-slate-300",children:["Debug: User UID: ",s==null?void 0:s.uid]}),e.jsxs("p",{className:"text-slate-300",children:["Debug: Party DM ID: ",n==null?void 0:n.dmId]}),e.jsxs("p",{className:"text-slate-300",children:["Debug: Is DM speaking: ",((f=i==null?void 0:i.currentSpeaker)==null?void 0:f.id)==="dm"?"Yes":"No"]}),e.jsxs("p",{className:"text-slate-300",children:["Debug: Is user DM: ",(s==null?void 0:s.uid)===(n==null?void 0:n.dmId)?"Yes":"No"]})]}),e.jsx("div",{className:"space-y-2",children:d().map(v=>{var P,$,S;const k=((P=i==null?void 0:i.currentSpeaker)==null?void 0:P.userId)===v.userId;s==null||s.uid,v.userId;const b=(($=i==null?void 0:i.currentSpeaker)==null?void 0:$.userId)===(s==null?void 0:s.uid)||((S=i==null?void 0:i.currentSpeaker)==null?void 0:S.id)==="dm"&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId)||!(i!=null&&i.currentSpeaker)&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId);return e.jsxs("div",{className:`p-2 rounded transition-colors ${k?"bg-blue-600/30 border border-blue-500":b?"bg-slate-700/50 hover:bg-slate-600/50 cursor-pointer":"bg-slate-700/30 opacity-60 cursor-not-allowed"}`,onClick:b?()=>p(v):void 0,children:[e.jsx("div",{className:"font-semibold text-slate-200 text-xs",children:v.name}),e.jsxs("div",{className:"text-slate-400 text-xs",children:[v.race," ",v.class]}),k&&e.jsx("div",{className:"text-blue-400 text-xs mt-1",children:"Currently Speaking"}),!b&&!k&&e.jsx("div",{className:"text-slate-500 text-xs mt-1",children:"Waiting for turn..."}),b&&!k&&e.jsx("div",{className:"text-green-400 text-xs mt-1",children:"Click to select"})]},v.id)})})]}),e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-4",children:[e.jsx("h3",{className:"font-bold text-slate-200 mb-3",children:"🎯 Campaign Objectives"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-slate-300 text-sm",children:[e.jsx("span",{className:"text-yellow-400",children:"●"})," Main Quest: Complete the adventure"]}),e.jsxs("div",{className:"text-slate-300 text-sm",children:[e.jsx("span",{className:"text-green-400",children:"●"})," Survive encounters"]}),e.jsxs("div",{className:"text-slate-300 text-sm",children:[e.jsx("span",{className:"text-blue-400",children:"●"})," Work together as a team"]})]})]})]})}),e.jsxs("div",{className:"lg:col-span-3",children:[e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-6 mb-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-bold text-slate-200 mb-2",children:((y=i==null?void 0:i.currentSpeaker)==null?void 0:y.name)||"Narrator"}),e.jsxs("div",{className:"text-slate-400 text-sm",children:[(j=i==null?void 0:i.currentSpeaker)==null?void 0:j.race," ",(E=i==null?void 0:i.currentSpeaker)==null?void 0:E.class]})]}),e.jsx("div",{className:"text-slate-300 leading-7 text-lg",dangerouslySetInnerHTML:{__html:u((i==null?void 0:i.currentContent)||"The story begins...")}})]}),(((D=i==null?void 0:i.currentSpeaker)==null?void 0:D.userId)===(s==null?void 0:s.uid)||((w=i==null?void 0:i.currentSpeaker)==null?void 0:w.id)==="dm"&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId)||!(i!=null&&i.currentSpeaker)&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId))&&e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-6 mb-6",children:[e.jsx("h3",{className:"font-bold text-slate-200 mb-4",children:"Dungeon Master Response"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("textarea",{value:l,onChange:v=>r(v.target.value),placeholder:"Continue the story or describe what happens next...",className:"w-full bg-slate-800/50 border border-slate-600 text-slate-100 px-4 py-3 rounded-lg focus:border-slate-500 focus:outline-none transition-colors min-h-[120px] resize-none",rows:4}),e.jsx("div",{className:"flex space-x-3",children:e.jsx("button",{onClick:m,disabled:!l.trim()||c,className:"bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed",children:c?"Processing...":"Continue Story"})})]})]}),e.jsxs("div",{className:"lg:hidden bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-bold text-slate-200 mb-3",children:"Party Members"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:d().map(v=>{var P,$,S;const k=((P=i==null?void 0:i.currentSpeaker)==null?void 0:P.userId)===v.userId;s==null||s.uid,v.userId;const b=(($=i==null?void 0:i.currentSpeaker)==null?void 0:$.userId)===(s==null?void 0:s.uid)||((S=i==null?void 0:i.currentSpeaker)==null?void 0:S.id)==="dm"&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId)||!(i!=null&&i.currentSpeaker)&&(s==null?void 0:s.uid)===(n==null?void 0:n.dmId);return e.jsxs("div",{className:`p-2 rounded transition-colors ${k?"bg-blue-600/30 border border-blue-500":b?"bg-slate-700/50 hover:bg-slate-600/50 cursor-pointer":"bg-slate-700/30 opacity-60 cursor-not-allowed"}`,onClick:b?()=>p(v):void 0,children:[e.jsx("div",{className:"font-semibold text-slate-200 text-xs",children:v.name}),e.jsxs("div",{className:"text-slate-400 text-xs",children:[v.race," ",v.class]}),k&&e.jsx("div",{className:"text-blue-400 text-xs mt-1",children:"Currently Speaking"}),!b&&!k&&e.jsx("div",{className:"text-slate-500 text-xs mt-1",children:"Waiting for turn..."}),b&&!k&&e.jsx("div",{className:"text-green-400 text-xs mt-1",children:"Click to select"})]},v.id)})})]}),(i==null?void 0:i.storyMessages)&&i.storyMessages.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-6 mt-8 shadow-lg",children:[e.jsx("div",{className:"mb-6",children:e.jsx("h3",{className:"text-xl font-bold text-slate-100 mb-2 border-b border-slate-600 pb-3",children:"📜 Story History"})}),e.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto",children:i.storyMessages.map((v,k)=>e.jsxs("div",{className:"border-l-4 border-slate-500 pl-4 py-2 bg-slate-800/30 rounded-r-lg",children:[e.jsxs("div",{className:"text-slate-300 text-sm font-semibold mb-2 flex items-center",children:[e.jsx("span",{className:"mr-2",children:"👤"}),v.speaker||"Narrator"]}),e.jsx("div",{className:"text-slate-400 text-sm leading-6 pl-6 border-l border-slate-600",dangerouslySetInnerHTML:{__html:u(v.content)}})]},k))})]})]})]})}function ot({story:i}){return e.jsxs(e.Fragment,{children:[(i==null?void 0:i.status)==="generating"&&e.jsx("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-8 max-w-4xl mx-auto mb-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-200 mb-4",children:"Generating Your Adventure"}),e.jsx("p",{className:"text-slate-300 text-lg mb-8",children:"The Dungeon Master is crafting your story. This may take a moment..."}),e.jsxs("div",{className:"flex justify-center items-center space-x-4 mb-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-slate-400"}),e.jsx("div",{className:"text-slate-300 font-semibold text-lg",children:"Creating Story Plots..."})]})]})}),(i==null?void 0:i.status)==="generating_story"&&e.jsx("div",{className:"bg-gradient-to-br from-slate-800/50 to-slate-700/50 border border-slate-600 rounded-lg p-8 max-w-4xl mx-auto mb-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-200 mb-4",children:"Crafting Your Story"}),e.jsx("p",{className:"text-slate-300 text-lg mb-8",children:"The Dungeon Master is weaving the tale of your adventure..."}),e.jsxs("div",{className:"flex justify-center items-center space-x-4 mb-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-slate-400"}),e.jsx("div",{className:"text-slate-300 font-semibold text-lg",children:"Generating Story Content..."})]}),(i==null?void 0:i.selectedPlotData)&&e.jsxs("div",{className:"bg-slate-900/50 rounded-lg p-4 max-w-2xl mx-auto",children:[e.jsxs("h3",{className:"text-slate-200 font-semibold mb-2",children:["Selected Plot: ",i.selectedPlotData.title]}),e.jsx("p",{className:"text-slate-300 text-sm",children:i.selectedPlotData.description})]})]})})]})}function rt({showDebug:i,story:n,user:s,party:t,partyMembers:a,isReady:o,allPlayersReady:l,combatLoading:r,hasNavigatedToCombat:c,onManualCombatTrigger:m,onResetCombatState:p}){var u,d,f;return i?e.jsxs("div",{className:"bg-gradient-to-br from-slate-900/50 to-slate-800/50 border border-slate-600 rounded-lg p-6 mb-6",children:[e.jsx("h3",{className:"font-bold text-slate-200 mb-4",children:"🐛 Debug Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-slate-300 font-semibold mb-2",children:"Story State"}),e.jsxs("div",{className:"space-y-1 text-slate-400",children:[e.jsxs("div",{children:["Story ID: ",(n==null?void 0:n.id)||"None"]}),e.jsxs("div",{children:["Status: ",(n==null?void 0:n.status)||"None"]}),e.jsxs("div",{children:["Phase: ",((u=n==null?void 0:n.storyMetadata)==null?void 0:u.phaseStatus)||"None"]}),e.jsxs("div",{children:["Ready Players: ",((d=n==null?void 0:n.readyPlayers)==null?void 0:d.length)||0,"/",a.length]}),e.jsxs("div",{children:["Current Speaker: ",((f=n==null?void 0:n.currentSpeaker)==null?void 0:f.name)||"None"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-slate-300 font-semibold mb-2",children:"User State"}),e.jsxs("div",{className:"space-y-1 text-slate-400",children:[e.jsxs("div",{children:["User ID: ",(s==null?void 0:s.uid)||"None"]}),e.jsxs("div",{children:["Is DM: ",(s==null?void 0:s.uid)===(t==null?void 0:t.dmId)?"Yes":"No"]}),e.jsxs("div",{children:["Is Ready: ",o?"Yes":"No"]}),e.jsxs("div",{children:["All Ready: ",l?"Yes":"No"]}),e.jsxs("div",{children:["Combat Loading: ",r?"Yes":"No"]}),e.jsxs("div",{children:["Has Navigated: ",c?"Yes":"No"]})]})]})]}),(s==null?void 0:s.uid)===(t==null?void 0:t.dmId)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-600",children:[e.jsx("h4",{className:"text-slate-300 font-semibold mb-2",children:"⚔️ Manual Combat Controls"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:m,disabled:r||c,className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:r?"Loading...":"Trigger Combat"}),e.jsx("button",{onClick:p,className:"bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors",children:"Reset State"})]})]})]}):null}function bt(){const{user:i,loading:n}=Ve(),{partyId:s}=We(),t=Ze(),{story:a,party:o,partyMembers:l,partyCharacters:r,loading:c,error:m,playerResponse:p,currentPhase:u,objectives:d,inlineValidation:f,showActionValidation:y,actionValidation:j,showDiceRoll:E,diceResult:D,isReady:w,allPlayersReady:v,isGeneratingPlots:k,showDebug:b,deadPlayers:P,showDeathRecap:$,combatLoading:S,hasNavigatedToCombat:Y,setPlayerResponse:M,setShowDebug:_,setShowDeathRecap:X,setError:Q,getReadyCount:he,getTotalPlayers:V,getSortedCharacters:ue,highlightKeywords:J,loadStoryAndCharacters:ee,handleReadyUp:te,handleStartStory:U,handlePlotSelection:se,handleSendResponse:G,handleSetSpeaker:ne,handleActionValidationClose:ae,handleActionProceed:ie,handleActionRevise:W,handleManualCombatTrigger:oe,handleResetCombatState:Z}=et(s,i,t);return xe.useEffect(()=>{!i&&!n&&t("/login")},[i,n,t]),xe.useEffect(()=>{console.log("CampaignStory: Checking redirect conditions",{storyStatus:a==null?void 0:a.status,campaignType:o==null?void 0:o.campaignType,partyId:s}),(a==null?void 0:a.status)==="active"&&(o==null?void 0:o.campaignType)==="manual"&&(console.log("CampaignStory: Redirecting to manual campaign page"),t(`/manual-campaign/${s}`))},[a==null?void 0:a.status,o==null?void 0:o.campaignType,s,t]),n||c?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-slate-400 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"Loading campaign..."})]})}):m&&!a?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-red-400 text-4xl mb-4",children:"⚠️"}),e.jsx("h2",{className:"text-2xl font-bold text-slate-200 mb-4",children:"Error Loading Campaign"}),e.jsx("p",{className:"text-slate-300 mb-6",children:m}),e.jsx("button",{onClick:()=>t("/dashboard"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors",children:"Return to Dashboard"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-slate-100 mb-2",children:(o==null?void 0:o.name)||"Campaign Story"}),e.jsx("p",{className:"text-slate-300 text-lg",children:(o==null?void 0:o.description)||"An epic adventure awaits!"})]}),(a==null?void 0:a.status)==="ready_up"&&(o==null?void 0:o.campaignType)!=="manual"&&e.jsx(nt,{story:a,party:o,user:i,partyCharacters:r,partyMembers:l,isReady:w,allPlayersReady:v,loading:c,isGeneratingPlots:k,onReadyUp:te,onStartStory:U,navigate:t,partyId:s}),(a==null?void 0:a.status)==="active"&&(o==null?void 0:o.campaignType)==="manual"&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-amber-400 border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-slate-300 text-lg",children:"Redirecting to manual campaign..."})]}),e.jsx(ot,{story:a}),(a==null?void 0:a.status)==="voting"&&e.jsx(at,{story:a,party:o,user:i,loading:c,showDebug:b,setShowDebug:_,onPlotSelection:se,onStartStory:U}),(a==null?void 0:a.status)==="storytelling"&&e.jsx(it,{story:a,party:o,user:i,partyCharacters:r,showDebug:b,setShowDebug:_,playerResponse:p,setPlayerResponse:M,loading:c,onSendResponse:G,onSetSpeaker:ne,highlightKeywords:J}),$&&P.length>0&&e.jsx("div",{className:"bg-gradient-to-r from-red-900/50 to-red-800/50 border border-red-600 rounded-lg p-6 mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"text-red-400 text-xl",children:"💀"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-red-200 mb-2",children:"Combat Aftermath"}),e.jsx("p",{className:"text-red-100 text-sm mb-3",children:"The battle has ended. Some heroes have fallen, but the story continues..."}),e.jsxs("div",{className:"bg-red-800/30 border border-red-600 rounded p-3 mb-3",children:[e.jsx("h4",{className:"text-red-200 font-semibold mb-2",children:"Fallen Heroes:"}),e.jsx("div",{className:"space-y-2",children:P.map((F,R)=>e.jsxs("div",{className:"text-red-200 text-sm",children:[e.jsx("strong",{children:F.name})," (",F.class,", Level ",F.level,") - ",F.deathCause]},R))})]}),e.jsx("p",{className:"text-red-100 text-xs",children:"The fallen heroes will need to create new characters to rejoin the adventure."})]}),e.jsx("button",{onClick:()=>X(!1),className:"text-red-400 hover:text-red-200 transition-colors",children:"✕"})]})}),m&&e.jsx("div",{className:"bg-gradient-to-r from-red-900/50 to-red-800/50 border border-red-600 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"text-red-400 text-xl",children:"⚠️"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-red-200 mb-2",children:"Notice"}),e.jsx("p",{className:"text-red-100 text-sm mb-3",children:m}),m.includes("AI service")&&e.jsxs("div",{className:"bg-red-800/30 border border-red-600 rounded p-3",children:[e.jsxs("p",{className:"text-red-200 text-xs mb-2",children:[e.jsx("strong",{children:"What this means:"})," The AI storytelling service is temporarily unavailable."]}),e.jsx("p",{className:"text-red-200 text-xs mb-2",children:e.jsx("strong",{children:"You can still:"})}),e.jsxs("ul",{className:"text-red-200 text-xs list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Continue the story manually by typing your responses"}),e.jsx("li",{children:"Use the predefined plot options if available"}),e.jsx("li",{children:"Wait a few minutes and try again"})]})]})]}),e.jsx("button",{onClick:()=>Q(""),className:"text-red-400 hover:text-red-200 transition-colors",children:"✕"})]})}),e.jsx(rt,{showDebug:b,story:a,user:i,party:o,partyMembers:l,isReady:w,allPlayersReady:v,combatLoading:S,hasNavigatedToCombat:Y,onManualCombatTrigger:oe,onResetCombatState:Z}),y&&e.jsx(tt,{validation:j,onClose:ae,onProceed:ie,onRevise:W}),E&&e.jsx(st,{result:D,onClose:()=>setShowDiceRoll(!1)})]})})}export{bt as default};
